{% extends "base.html" %}

{% block title %}CPC New Haven - Everyone is truly welcomed{% endblock %}

{% block head %}
<style>
    /* ===== UNIFIED BLUE THEME (same blue as Teaching Series / Resources) ===== */
    .section-dark {
        background: var(--bg-gradient);
    }
    .section-heading {
        font-size: 2rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.98);
    }
    .section-subheading {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
    }
    /* Dark cards matching teaching series */
    .dark-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .dark-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    .dark-card h3 {
        color: rgba(255, 255, 255, 0.95);
    }
    .dark-card-text {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }
    /* Service info dark theme */
    .service-info.section-dark {
        padding: 3rem 0;
    }
    .service-times {
        max-width: 900px;
        margin: 0 auto;
    }
    .service-schedule {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .time-slot {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.25rem;
        transition: all 0.3s ease;
    }
    .time-slot:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
    }
    .time-slot h3 {
        color: rgba(255, 255, 255, 0.95);
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }
    .time-slot p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin: 0;
    }
    .time-slot.featured {
        background: rgba(0, 102, 204, 0.15);
        border: 1px solid rgba(0, 102, 204, 0.3);
    }
    .time-slot.featured:hover {
        background: rgba(0, 102, 204, 0.2);
        border-color: rgba(0, 102, 204, 0.4);
    }
    /* Pull quote dark theme */
    .section-dark .pull-quote {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    .section-dark .pull-quote .quote-text {
        color: rgba(255, 255, 255, 0.95);
    }
    .section-dark .pull-quote .quote-sub {
        color: rgba(255, 255, 255, 0.7);
    }

    /* Fading rotating banner */
    .hero-banner {
        position: relative;
        width: 100%;
        min-height: 420px;
        overflow: hidden;
        background: #0a1628;
    }
    .hero-banner .banner-slide {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center 20%;
        opacity: 0;
        transition: opacity 1.2s ease-in-out;
        z-index: 0;
    }
    .hero-banner .banner-slide.active {
        opacity: 1;
        z-index: 1;
    }
    .hero-banner .banner-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0.75), rgba(0,0,0,0.55), rgba(0,0,0,0.8));
        z-index: 2;
        pointer-events: none;
    }
    .hero-banner .splash-content {
        position: relative;
        z-index: 3;
        color: white;
    }
    .hero-banner .splash-content h1,
    .hero-banner .splash-content h2 {
        color: rgba(255, 255, 255, 0.98);
        text-shadow: 0 3px 14px rgba(0, 0, 0, 0.6);
    }
    .hero-banner .splash-content p {
        color: rgba(255, 255, 255, 0.85);
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
    .hero-banner .banner-dots {
        position: absolute;
        bottom: 1.25rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 3;
        display: flex;
        gap: 0.5rem;
    }
    .hero-banner .banner-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255,255,255,0.5);
        cursor: pointer;
        transition: background 0.3s, transform 0.3s;
    }
    .hero-banner .banner-dots span.active {
        background: #fff;
        transform: scale(1.2);
    }

    /* Latest & Greatest grid */
    .latest-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.25rem;
        width: 100%;
    }
    .latest-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 1.25rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .latest-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    }
    .latest-card h3 {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(255, 255, 255, 0.65);
        margin-bottom: 0.5rem;
    }
    .latest-card .latest-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.98);
        margin-bottom: 0.35rem;
        line-height: 1.3;
    }
    .latest-card .latest-meta {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0.75rem;
    }
    .latest-card a.cta {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: #5AC8FA;
        text-decoration: none;
    }
    .latest-card a.cta:hover { color: #7dd8ff; }

    .section-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 0.5rem;
    }
    .events-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .events-list li {
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
    }
    .events-list li:last-child { border-bottom: none; }
    .events-list .event-date {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        flex-shrink: 0;
    }
    .events-list .event-title {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.95);
    }
    .contact-strip {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1.5rem 2rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .contact-strip a, .contact-strip span {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-size: 0.95rem;
    }
    .contact-strip a:hover { color: #5AC8FA; }

    /* Latest card styles consistent with dark theme */

    @media (max-width: 768px) {
        .hero-banner { min-height: 320px; }
        .hero-banner .banner-slide { background-position: center 15%; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Fading rotating banner -->
<section class="hero-banner" id="home-image" aria-label="Welcome banner">
    <div class="banner-slide active" data-index="0" style="background-image: url('https://storage.googleapis.com/cpc-public-website/media-gallery/womans-fall-brunch-2024/605c1ade-b21e-4713-ad4e-d9bb2d6709ad.JPG');"></div>
    <div class="banner-slide" data-index="1" style="background-image: url('https://storage.googleapis.com/cpc-public-website/media-gallery/womans-fall-brunch-2024/89c3ea3b-e196-4318-bee8-08b5e66e728d.JPG');"></div>
    <div class="banner-slide" data-index="2" style="background-image: url('https://storage.googleapis.com/cpc-public-website/events/Hill%20Christmas%20Store%202023/IMG_0244.JPG');"></div>
    <div class="banner-slide" data-index="3" style="background-image: url('https://storage.googleapis.com/cpc-public-website/events/Young%20Adults%20Cookout%20-%20September%202025/2.jpg');"></div>
    <div class="banner-slide" data-index="4" style="background-image: url('https://storage.googleapis.com/cpc-public-website/events/Young%20Adults%20Cookout%20-%20September%202025/4.jpg');"></div>
    <div class="banner-overlay"></div>
    <div class="splash-content mx-auto max-w-3xl px-4 md:px-6 py-16 md:py-20 text-center relative">
        <h1>Christ Presbyterian Church</h1>
        <h2>New Haven, CT</h2>
        <p>Everyone is truly welcomed into God's presence because there is no limit to God's grace as accomplished for us by Christ.</p>
        <div class="splash-buttons mt-4 md:mt-6">
            <a href="{{ url_for('live') }}" class="btn btn-primary">Watch Live</a>
            <a href="{{ url_for('plan_a_vist') }}" class="btn btn-secondary">Plan a Visit</a>
            <a href="{{ url_for('what_we_believe') }}" class="btn btn-secondary">What We Believe</a>
            <a href="{{ url_for('sermons') }}" class="btn btn-secondary">Latest Sermon</a>
        </div>
    </div>
    <div class="banner-dots" id="bannerDots" aria-hidden="true"></div>
</section>

<!-- New Content Section (announcements / latest from admin) -->
<section class="highlights-section section-dark new-content-section" style="padding: 4rem 0; position: relative;">
    <div class="container" style="position: relative; z-index: 1;">
        <div class="section-header" style="text-align: center; margin-bottom: 2.5rem;">
            <h2 class="section-heading" style="margin-bottom: 0.5rem;">New Content</h2>
            <p class="section-subheading">Announcements and the latest from CPC</p>
        </div>
        <div id="highlights" class="highlights-grid"></div>
        <div id="highlights-extra" class="highlights-grid highlights-extra" style="display: none; margin-top: 1rem;"></div>
        <div id="new-content-actions" style="text-align: center; margin-top: 2rem; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 1rem;">
            <button type="button" id="show-all-new-content-btn" class="btn btn-secondary" style="display: none;">Show all new content</button>
            <a href="{{ url_for('highlights') }}" class="glass-icon-button"><i class="fas fa-arrow-right"></i></a>
        </div>
    </div>
</section>

<!-- What you need -->
<section class="section-band section-dark" style="padding: 3rem 0;">
    <div class="container">
        <h2 class="section-heading mb-1">What you need</h2>
        <p class="section-subheading mb-6 max-w-2xl">Your next steps — latest sermon, this Sunday, and resources from our pastors.</p>

        <div class="latest-grid" id="latestGrid">
            <div class="latest-card" id="card-sermon">
                <h3>Latest Sermon</h3>
                <div class="latest-title" id="latestSermonTitle">—</div>
                <div class="latest-meta" id="latestSermonMeta"></div>
                <a href="{{ url_for('sermons') }}" class="cta" id="latestSermonLink">Listen / Watch →</a>
            </div>
            <div class="latest-card" id="card-sunday">
                <h3>Upcoming Sunday</h3>
                <div class="latest-title" id="upcomingSundayDate">—</div>
                <div class="latest-meta" id="upcomingSundayMeta">10:30am Worship · 135 Whitney Ave</div>
                <a href="{{ url_for('index') }}#service-info" class="cta">Service info →</a>
            </div>
            <div class="latest-card" id="card-book">
                <h3>Pastor’s Book</h3>
                <div class="latest-title">Resources from our pastors</div>
                <div class="latest-meta">Books, articles, and recommended reading.</div>
                <a href="{{ url_for('resources') }}" class="cta">Resources →</a>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mt-10">
            <div>
                <div class="section-label" id="eventsMonthLabel">Upcoming events this month</div>
                <ul class="events-list" id="eventsThisMonth">
                    <li><span class="event-title">Loading…</span></li>
                </ul>
                <a href="{{ url_for('events') }}" class="cta mt-2 inline-block">All events →</a>
            </div>
            <div>
                <div class="section-label">Contact</div>
                <div class="contact-strip">
                    <span>135 Whitney Ave, New Haven, CT 06510</span>
                    <a href="mailto:admin@cpcnewhaven.org">admin@cpcnewhaven.org</a>
                    <a href="{{ url_for('contact') }}">Contact form</a>
                    <span>Sunday Worship: 10:30am</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Service Info -->
<section id="service-info" class="service-info section-dark -mt-4">
    <div class="container">
        <div class="service-times">
            <h2 class="section-heading border-l-4 border-blue-400 pl-3">Sunday Service Information</h2>
            <div class="service-schedule leading-relaxed">
                <div class="time-slot">
                    <h3>8:30am</h3>
                    <p>Prayer in the Parlor</p>
                </div>
                <div class="time-slot">
                    <h3>9:30am</h3>
                    <p>Children's Sunday School &amp; Adult Sunday Studies</p>
                </div>
                <div class="time-slot featured">
                    <h3>10:30am</h3>
                    <p>Sunday Worship Service</p>
                </div>
                <div class="time-slot">
                    <h3>12:00pm</h3>
                    <p>Fellowship Lunch</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Welcome / New Here -->
<section class="section-band section-dark">
    <div class="container">
        <div class="text-center mb-6">
            <h2 class="section-heading mb-2">New Here? Start with These</h2>
            <p class="section-subheading max-w-2xl mx-auto">Plan your first visit, learn what we believe, and meet people who can help you feel at home.</p>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
            <div class="dark-card p-6">
                <h3 class="text-lg font-semibold mb-2">Plan a Visit</h3>
                <p class="dark-card-text mb-4">Service times, parking tips, and what to expect on Sunday.</p>
                <a href="{{ url_for('plan_a_vist') }}" class="btn btn-primary">Start Here</a>
            </div>
            <div class="dark-card p-6">
                <h3 class="text-lg font-semibold mb-2">What We Believe</h3>
                <p class="dark-card-text mb-4">Our faith, confessional standards, and what we teach from Scripture.</p>
                <a href="{{ url_for('what_we_believe') }}" class="btn btn-secondary">What We Believe</a>
            </div>
            <div class="dark-card p-6">
                <h3 class="text-lg font-semibold mb-2">Meet the Team</h3>
                <p class="dark-card-text mb-4">Connect with our pastors and staff.</p>
                <a href="{{ url_for('contact') }}" class="btn btn-secondary">Contact Us</a>
            </div>
        </div>
    </div>
</section>

<!-- Pull Quote -->
<section class="section-band section-dark">
    <div class="container">
        <div class="pull-quote fade-up">
            <div class="quote-text">Though we may be more sinful than we're even willing to imagine, we are more loved in Christ than we can ever dare to hope.</div>
            <div class="quote-sub">You are welcome here.</div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // ----- Fading rotating banner -----
    var slides = document.querySelectorAll('.hero-banner .banner-slide');
    var dotsContainer = document.getElementById('bannerDots');
    var current = 0;
    var interval = 5500;

    if (slides.length && dotsContainer) {
        slides.forEach(function(_, i) {
            var dot = document.createElement('span');
            dot.setAttribute('role', 'button');
            dot.setAttribute('aria-label', 'Go to slide ' + (i + 1));
            if (i === 0) dot.classList.add('active');
            dot.addEventListener('click', function() {
                current = i;
                goTo(current);
                clearInterval(timer);
                timer = setInterval(next, interval);
            });
            dotsContainer.appendChild(dot);
        });
    }

    function goTo(index) {
        current = (index + slides.length) % slides.length;
        slides.forEach(function(s, i) {
            s.classList.toggle('active', i === current);
        });
        var dots = dotsContainer ? dotsContainer.querySelectorAll('span') : [];
        dots.forEach(function(d, i) {
            d.classList.toggle('active', i === current);
        });
    }

    function next() {
        goTo(current + 1);
    }

    var timer = setInterval(next, interval);

    // ----- Latest & Greatest data -----
    var eventsMonthLabel = document.getElementById('eventsMonthLabel');
    var eventsThisMonth = document.getElementById('eventsThisMonth');

    function formatEventDate(iso) {
        if (!iso) return '';
        var d = new Date(iso);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function setEventsThisMonth(events, monthName) {
        eventsMonthLabel.textContent = 'Upcoming events — ' + (monthName || 'this month');
        if (!events || events.length === 0) {
            eventsThisMonth.innerHTML = '<li><span class="event-title">No events this month. <a href="{{ url_for("events") }}">View all events</a></span></li>';
            return;
        }
        eventsThisMonth.innerHTML = events.slice(0, 8).map(function(ev) {
            return '<li><span class="event-date">' + formatEventDate(ev.start) + '</span><span class="event-title">' + (ev.title || 'Event') + '</span></li>';
        }).join('');
    }

    // Upcoming Sunday: this or next Sunday's date
    (function() {
        var el = document.getElementById('upcomingSundayDate');
        if (!el) return;
        var d = new Date();
        var day = d.getDay();
        var daysUntilSunday = day === 0 ? 0 : 7 - day;
        var nextSunday = new Date(d);
        nextSunday.setDate(d.getDate() + daysUntilSunday);
        el.textContent = nextSunday.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    })();

    // Fetch sermons -> latest = first episode
    fetch('/api/sermons').then(function(r) { return r.json(); }).then(function(data) {
        var episodes = (data && data.episodes) || [];
        var latest = episodes[0];
        var el = document.getElementById('latestSermonTitle');
        var meta = document.getElementById('latestSermonMeta');
        var link = document.getElementById('latestSermonLink');
        if (el && latest) {
            el.textContent = latest.title || 'Latest sermon';
            meta.textContent = (latest.author ? latest.author + ' · ' : '') + (latest.date ? formatEventDate(latest.date) : '');
            var url = latest.youtube_url || latest.spotify_url || latest.link || latest.apple_podcasts_url;
            if (link && url) {
                link.href = url;
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener');
            }
        }
    }).catch(function() {});

    // Fetch events -> filter by current month
    fetch('/api/events').then(function(r) { return r.json(); }).then(function(data) {
        var events = (data && data.events) || [];
        var now = new Date();
        var thisMonth = now.getMonth();
        var thisYear = now.getFullYear();
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        var inMonth = events.filter(function(ev) {
            if (!ev.start) return false;
            var d = new Date(ev.start);
            return d.getMonth() === thisMonth && d.getFullYear() === thisYear && d >= now;
        });
        inMonth.sort(function(a, b) {
            return (a.start || '').localeCompare(b.start || '');
        });
        setEventsThisMonth(inMonth, monthNames[thisMonth]);
    }).catch(function() {
        eventsThisMonth.innerHTML = '<li><span class="event-title">Unable to load events. <a href="{{ url_for("events") }}">View events</a></span></li>';
    });
})();
</script>
<script>
// New Content grid: latest 6, then "Show all new content" reveals rest as previews
document.addEventListener('DOMContentLoaded', function() {
    var INITIAL_COUNT = 6;
    var allActive = [];

    function getTypeBadgeColor(type) {
        var c = { 'event': 'rgba(0, 122, 255, 0.15)', 'announcement': 'rgba(255, 215, 0, 0.15)', 'ongoing': 'rgba(52, 199, 89, 0.15)', 'upcoming': 'rgba(255, 149, 0, 0.15)' };
        return c[type] || 'rgba(255, 255, 255, 0.1)';
    }
    function getTypeBadgeTextColor(type) {
        var c = { 'event': '#007AFF', 'announcement': '#FFD700', 'ongoing': '#34C759', 'upcoming': '#FF9500' };
        return c[type] || '#FFFFFF';
    }
    function stripHtml(html) {
        var tmp = document.createElement('div');
        tmp.innerHTML = html || '';
        return tmp.textContent || tmp.innerText || '';
    }
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function buildCard(h) {
        var card = document.createElement('div');
        card.className = 'highlight-card' + (h.superfeatured ? ' superfeatured' : '');
        var imgHtml = h.featuredImage ? '<div style="position:relative;height:200px;overflow:hidden;"><img src="' + h.featuredImage + '" alt="" style="width:100%;height:100%;object-fit:cover;"><div style="position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);"></div></div>' : '';
        card.innerHTML = imgHtml + '<div style="padding:1.25rem;"><span style="display:inline-block;padding:4px 10px;border-radius:50px;font-size:0.7rem;font-weight:700;text-transform:uppercase;background:' + getTypeBadgeColor(h.type) + ';color:' + getTypeBadgeTextColor(h.type) + ';">' + (h.type || 'Announcement') + '</span><h3 style="color:rgba(255,255,255,0.98);font-size:1.1rem;margin:0.5rem 0 0.35rem;">' + (h.title || '') + '</h3><p style="color:rgba(255,255,255,0.75);font-size:0.9rem;margin:0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">' + stripHtml(h.description) + '</p><div style="margin-top:0.75rem;font-size:0.85rem;color:rgba(255,255,255,0.6);">' + (h.dateEntered ? formatDate(h.dateEntered) : '') + '</div></div>';
        return card;
    }

    function renderItems(container, items) {
        container.innerHTML = '';
        items.forEach(function(h) {
            container.appendChild(buildCard(h));
        });
    }

    fetch('/api/highlights').then(function(r) { return r.json(); }).then(function(data) {
        var container = document.getElementById('highlights');
        var extraContainer = document.getElementById('highlights-extra');
        var btn = document.getElementById('show-all-new-content-btn');
        if (!container) return;

        allActive = (data.announcements || []).filter(function(h) { return h.active === 'true' || h.active === true; });
        allActive.sort(function(a, b) {
            if (a.superfeatured && !b.superfeatured) return -1;
            if (!a.superfeatured && b.superfeatured) return 1;
            return new Date(b.dateEntered) - new Date(a.dateEntered);
        });

        if (allActive.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.6);grid-column:1/-1;">No new content at this time.</p>';
            return;
        }

        var initial = allActive.slice(0, INITIAL_COUNT);
        var rest = allActive.slice(INITIAL_COUNT);
        renderItems(container, initial);

        if (rest.length > 0 && extraContainer && btn) {
            renderItems(extraContainer, rest);
            btn.style.display = 'inline-block';
            btn.textContent = 'Show all new content';
            btn.addEventListener('click', function() {
                var isExpanded = extraContainer.style.display === 'grid';
                if (isExpanded) {
                    extraContainer.style.display = 'none';
                    btn.textContent = 'Show all new content';
                } else {
                    extraContainer.style.display = 'grid';
                    btn.textContent = 'Show less';
                }
            });
        }
    }).catch(function() {
        var c = document.getElementById('highlights');
        if (c) c.innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.6);">Unable to load new content.</p>';
    });
});
</script>
{% endblock %}
