<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}CPC New Haven{% endblock %}</title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Unified Stylesheet -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}">

        <!-- Alpine.js for reactive components -->
        <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
            defer></script>

        <!-- Papa Parse for CSV parsing if needed -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

        {% block head %}{% endblock %}
    </head>
    <body>
        <!-- Warning Banner -->
        <div id="warningBanner" class="warning-banner"
            style="display: none;"></div>

        <!-- Desktop Navigation -->
        <nav
            class="top-nav hidden md:flex w-full max-w-6xl mx-auto rounded-lg py-3 px-6 items-center justify-between fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <ul class="flex items-center gap-2">
                <li><a href="{{ url_for('index') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">Home</a></li>
                <li><a href="{{ url_for('about') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">About</a></li>
                <li><a href="{{ url_for('about') }}"
                        class="text-white hover:text-blue-200 font-semibold px-3 py-2 rounded text-sm">Plan a Visit</a></li>
                <li class="hidden md:block">
                    <form @submit.prevent="window.location.href='{{ url_for('search') }}?q='+encodeURIComponent($refs.navq.value)">
                        <input x-ref="navq" type="search" placeholder="Search..."
                            class="px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none text-sm"
                            autocomplete="off" style="min-width: 180px;">
                    </form>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Community
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('highlights') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Highlights</a></li>
                        <li><a href="{{ url_for('events') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Events</a></li>
                        <li><a href="{{ url_for('announcements') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Announcements</a></li>
                        <li><a href="{{ url_for('community') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Community</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Media
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('media') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Gallery</a></li>
                        <li><a href="{{ url_for('sermons') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Sermons</a></li>
                        <li><a href="{{ url_for('podcasts') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Podcasts</a></li>
                        <li><a href="{{ url_for('live') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Live
                                Stream <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(255,0,0,0.2); color:#fff; border:1px solid rgba(255,255,255,0.25);">LIVE</span></a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Resources
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('resources') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Resources</a></li>
                        <li><a href="{{ url_for('give') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Give</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">More
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('search') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Search</a></li>
                        <li><a href="{{ url_for('archive') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Archive</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Mobile Navigation -->
        <nav x-data="{ open: false }"
            class="top-nav flex md:hidden w-full max-w-6xl mx-auto rounded-lg py-3 px-4 items-center justify-between fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <button @click="open = !open"
                class="text-3xl text-white">☰</button>
            <div x-show="open" x-transition
                class="absolute top-full left-0 right-0 rounded-lg shadow-lg mt-2 space-y-2 p-4 backdrop-blur-lg"
                style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                <a href="{{ url_for('index') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">Home</a>
                <a href="{{ url_for('about') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">About</a>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Community</p>
                    <a href="{{ url_for('highlights') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Highlights</a>
                    <a href="{{ url_for('events') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Events</a>
                    <a href="{{ url_for('announcements') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Announcements</a>
                    <a href="{{ url_for('community') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Community</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Media</p>
                    <a href="{{ url_for('media') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Gallery</a>
                    <a href="{{ url_for('sermons') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Sermons</a>
                    <a href="{{ url_for('podcasts') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Podcasts</a>
                    <a href="{{ url_for('live') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Live
                        Stream</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Resources</p>
                    <a href="{{ url_for('resources') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Resources</a>
                    <a href="{{ url_for('give') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Give</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">More</p>
                    <a href="{{ url_for('search') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Search</a>
                    <a href="{{ url_for('archive') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Archive</a>
                </div>
            </div>
        </nav>

        <!-- Fixed Left Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-left hidden lg:block" x-data>
            <div class="dashboard-section">
                <div class="flex items-center gap-2">
                    <a href="{{ url_for('index') }}" class="start-tile" title="Start">
                        <i class="fa-brands fa-windows"></i>
                        <span>Start</span>
                    </a>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Quick Search</div>
                <form @submit.prevent="window.location.href='{{ url_for('search') }}?q='+encodeURIComponent($refs.leftSearch.value)">
                    <input x-ref="leftSearch" type="search" placeholder="Search site..."
                        class="w-full px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none"
                        autocomplete="off">
                </form>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Navigation</div>
                <div class="main-nav">
                    <a href="{{ url_for('index') }}"><i class="fa-solid fa-house"></i><span>Home</span></a>
                    <a href="{{ url_for('highlights') }}"><i class="fa-solid fa-star"></i><span>Highlights</span></a>
                    <a href="{{ url_for('events') }}"><i class="fa-solid fa-calendar-days"></i><span>Events</span></a>
                    <a href="{{ url_for('announcements') }}"><i class="fa-solid fa-bullhorn"></i><span>Announcements</span></a>
                    <a href="{{ url_for('sermons') }}"><i class="fa-solid fa-book-bible"></i><span>Sermons</span></a>
                    <a href="{{ url_for('podcasts') }}"><i class="fa-solid fa-podcast"></i><span>Podcasts</span></a>
                </div>
            </div>
            <div class="dashboard-section" x-show="$store.dash.showQuickLinks">
                <div class="dashboard-title">Quick Links</div>
                <div class="quick-links-grid">
                    <a href="{{ url_for('search') }}"><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></a>
                    <a href="{{ url_for('archive') }}"><i class="fa-solid fa-box-archive"></i><span>Archive</span></a>
                    <a href="{{ url_for('sermons') }}"><i class="fa-solid fa-book-bible"></i><span>Sermons</span></a>
                    <a href="{{ url_for('podcasts') }}"><i class="fa-solid fa-podcast"></i><span>Podcasts</span></a>
                    <a href="{{ url_for('events') }}"><i class="fa-solid fa-calendar-days"></i><span>Events</span></a>
                    <a href="{{ url_for('announcements') }}"><i class="fa-solid fa-bullhorn"></i><span>News</span></a>
                    <a href="{{ url_for('give') }}"><i class="fa-solid fa-hand-holding-heart"></i><span>Give</span></a>
                    <a href="{{ url_for('contact') }}"><i class="fa-solid fa-envelope"></i><span>Contact</span></a>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Customize</div>
                <div class="flex flex-col gap-2 text-white/90">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.compact"
                            @change="$store.dash.compact = !$store.dash.compact; $store.dash.save()">
                        <span>Compact mode</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.showQuickLinks"
                            @change="$store.dash.showQuickLinks = !$store.dash.showQuickLinks; $store.dash.save()">
                        <span>Show Quick Links</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.showService"
                            @change="$store.dash.showService = !$store.dash.showService; $store.dash.save()">
                        <span>Show Sunday Service</span>
                    </label>
                </div>
                <div class="mt-3">
                    <a href="/admin" class="glass-button w-full block text-center">Admin Login</a>
                </div>
            </div>
        </aside>

        <!-- Fixed Right Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-right hidden xl:block" :class="$store.dash.compact ? 'text-sm' : ''">
            <div class="dashboard-section">
                <div class="dashboard-title">Account</div>
                <div class="text-white/90" x-data>
                    <template x-if="$store.dash.userName">
                        <div class="flex items-center justify-between gap-2">
                            <span>Welcome, <strong x-text="$store.dash.userName"></strong></span>
                            <button class="glass-button" @click="$store.dash.userName=''; $store.dash.save()">Sign out</button>
                        </div>
                    </template>
                    <template x-if="!$store.dash.userName">
                        <div class="flex items-center justify-between gap-2">
                            <input x-ref="userInput" type="text" placeholder="Your name"
                                   class="px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none">
                            <button class="glass-button" @click="$store.dash.userName=$refs.userInput.value.trim(); $store.dash.save()">Sign in</button>
                        </div>
                    </template>
                    <div class="mt-2">
                        <a href="/admin" class="glass-button w-full block text-center">Admin Login</a>
                    </div>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Now</div>
                <div class="dashboard-note">
                    <div id="liveClock" class="text-white text-lg font-semibold"></div>
                    <div id="liveDate" class="text-white/80 text-sm mt-1"></div>
                </div>
            </div>
            <div class="dashboard-section" x-show="$store.dash.showService">
                <div class="dashboard-title">Sunday Service</div>
                <div class="dashboard-note">
                    10:30am Worship • 135 Whitney Ave
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Stay Connected</div>
                <ul class="dashboard-list">
                    <li><a href="https://www.instagram.com/cpcnewhaven" target="_blank" class="dashboard-link" title="Instagram"><i class="fa-brands fa-instagram"></i></a></li>
                    <li><a href="https://www.youtube.com/@cpcnewhaven" target="_blank" class="dashboard-link" title="YouTube"><i class="fa-brands fa-youtube"></i></a></li>
                    <li><a href="{{ url_for('contact') }}" class="dashboard-link" title="Contact"><i class="fa-solid fa-envelope"></i></a></li>
                </ul>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Manage Content</div>
                <div class="text-white/90 mb-2">Sign in to post highlights, edit events, and manage media.</div>
                <a href="/admin" class="glass-button w-full block text-center">Sign in to Admin</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="pt-8 md:pt-24 pb-20 dashboard-main">
            <div class="dashboard-panel">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Footer Ticker (announcements/highlights) -->
        <div class="footer-ticker">
            <div class="footer-ticker-inner">
                <div class="ticker-content" id="footerTickerTrack">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Start Menu Bar (icon dock) -->
        <div class="start-menu-bar">
            <a href="{{ url_for('index') }}" title="Home"><i class="fa-solid fa-house"></i></a>
            <a href="{{ url_for('highlights') }}" title="Highlights"><i class="fa-solid fa-star"></i></a>
            <a href="{{ url_for('sermons') }}" title="Sermons"><i class="fa-solid fa-book-bible"></i></a>
            <a href="{{ url_for('podcasts') }}" title="Podcasts"><i class="fa-solid fa-podcast"></i></a>
            <a href="{{ url_for('give') }}" title="Give"><i class="fa-solid fa-hand-holding-heart"></i></a>
            <a href="{{ url_for('search') }}" title="Search"><i class="fa-solid fa-magnifying-glass"></i></a>
            <div class="start-menu-meta">© 2025 CPC New Haven</div>
        </div>

        <!-- Footer removed in favor of dashboard dock/meta -->
        <footer class="hidden"></footer>

        <!-- Keep all your existing JavaScript files -->
        <script
            src="{{ url_for('static', filename='js/dynamic-banner.js') }}"></script>
        <script
            src="{{ url_for('static', filename='js/background-parallax-magic.js') }}"></script>

        <!-- Dropdown Navigation JavaScript -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle dropdown clicks
            document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdown = this.closest('.nav-dropdown');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    const isActive = menu.classList.contains('hidden');
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                    
                    // Toggle current dropdown
                    if (isActive) {
                        menu.classList.remove('hidden');
                    } else {
                        menu.classList.add('hidden');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                }
            });
        });
        </script>

        <!-- Dashboard Settings Store -->
        <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('dash', {
                compact: JSON.parse(localStorage.getItem('dash_compact') || 'false'),
                showQuickLinks: JSON.parse(localStorage.getItem('dash_showQuickLinks') || 'true'),
                showService: JSON.parse(localStorage.getItem('dash_showService') || 'true'),
                userName: localStorage.getItem('dash_userName') || '',
                save() {
                    localStorage.setItem('dash_compact', JSON.stringify(this.compact));
                    localStorage.setItem('dash_showQuickLinks', JSON.stringify(this.showQuickLinks));
                    localStorage.setItem('dash_showService', JSON.stringify(this.showService));
                    localStorage.setItem('dash_userName', this.userName || '');
                }
            });
        });
        </script>

        <!-- Live Clock -->
        <script>
        (function() {
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                const t = document.getElementById('liveClock');
                const d = document.getElementById('liveDate');
                if (t) t.textContent = time;
                if (d) d.textContent = date;
            }
            updateClock();
            setInterval(updateClock, 1000 * 30);
        })();
        </script>
        <!-- Footer Ticker Script -->
        <script>
        (function() {
            const track = document.getElementById('footerTickerTrack');
            if (!track) return;
            function sanitize(html) {
                const tmp = document.createElement('div');
                tmp.textContent = html;
                return tmp.innerHTML;
            }
            function truncate(text, max) {
                if (!text) return '';
                const t = text.trim();
                return t.length > max ? t.slice(0, max - 1) + '…' : t;
            }
            async function loadItems() {
                let items = [];
                try {
                    const r = await fetch('/api/highlights');
                    if (r.ok) {
                        const data = await r.json();
                        items = (data.announcements || []).filter(a => a && (a.active === true || a.active === "true"));
                    }
                } catch(e) {}
                if (!items.length) {
                    // Fallback blurbs
                    items = [
                        { type: 'News', title: 'Welcome to CPC — You are loved in Christ.' },
                        { type: 'Event', title: 'Sunday Worship · 10:30am · 135 Whitney Ave' },
                        { type: 'Featured', title: 'Community Dinner · Wednesday 6pm' }
                    ];
                }
                const parts = items.slice(0, 12).map(it => {
                    const type = sanitize(it.type || 'Update');
                    const title = sanitize(truncate(it.title || it.description || '', 120));
                    return `<span class="ticker-item"><span class="badge">${type}</span><span>${title}</span></span>`;
                });
                // Duplicate content to enable seamless marquee
                track.innerHTML = parts.concat(parts).join('<span class="ticker-item">•</span>');
            }
            loadItems();
        })();
        </script>

        {% block scripts %}{% endblock %}

    </body>
</html>
