<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}CPC New Haven{% endblock %}</title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Unified Stylesheet -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}">

        <!-- Alpine.js for reactive components -->
        <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
            defer></script>

        <!-- Papa Parse for CSV parsing if needed -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

        {% block head %}{% endblock %}
    </head>
    <body>
        <!-- Warning Banner -->
        <div id="warningBanner" class="warning-banner"
            style="display: none;"></div>

        <!-- Desktop Navigation -->
        <nav
            class="top-nav hidden md:flex w-full max-w-6xl mx-auto rounded-lg py-2.5 px-5 items-center justify-between fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); border-bottom: 1px solid rgba(255,255,255,0.35); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <ul class="flex items-center gap-2">
                <li><a href="{{ url_for('index') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">Home</a></li>
                <li><a href="{{ url_for('about') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">About</a></li>
                <li><a href="{{ url_for('about') }}"
                        class="text-white hover:text-blue-200 font-semibold px-3 py-2 rounded text-sm">Plan a Visit</a></li>
                <li class="hidden md:block">
                    <form @submit.prevent="window.location.href='{{ url_for('search') }}?q='+encodeURIComponent($refs.navq.value)">
                        <input x-ref="navq" type="search" placeholder="Search..."
                            class="px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none text-sm"
                            autocomplete="off" style="min-width: 180px;">
                    </form>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Community
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('highlights') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Highlights</a></li>
                        <li><a href="{{ url_for('events') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Events</a></li>
                        <li><a href="{{ url_for('announcements') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Announcements</a></li>
                        <li><a href="{{ url_for('community') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Community</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Media
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('media') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Gallery</a></li>
                        <li><a href="{{ url_for('sermons') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Sermons</a></li>
                        <li><a href="{{ url_for('podcasts') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Podcasts</a></li>
                        <li><a href="{{ url_for('live') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Live
                                Stream <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(255,0,0,0.2); color:#fff; border:1px solid rgba(255,255,255,0.25);">LIVE</span></a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Resources
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('resources') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Resources</a></li>
                        <li><a href="{{ url_for('give') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Give</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">More
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('search') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Search</a></li>
                        <li><a href="{{ url_for('archive') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Archive</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Mobile Navigation -->
        <nav x-data="{ open: false }"
            class="top-nav flex md:hidden w-full max-w-6xl mx-auto rounded-lg py-2.5 px-4 items-center justify-between fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); border-bottom: 1px solid rgba(255,255,255,0.35); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <button @click="open = !open"
                class="text-3xl text-white">‚ò∞</button>
            <div x-show="open" x-transition
                class="absolute top-full left-0 right-0 rounded-lg shadow-lg mt-2 space-y-2 p-4 backdrop-blur-lg"
                style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                <a href="{{ url_for('index') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">Home</a>
                <a href="{{ url_for('about') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">About</a>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Community</p>
                    <a href="{{ url_for('highlights') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Highlights</a>
                    <a href="{{ url_for('events') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Events</a>
                    <a href="{{ url_for('announcements') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Announcements</a>
                    <a href="{{ url_for('community') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Community</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Media</p>
                    <a href="{{ url_for('media') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Gallery</a>
                    <a href="{{ url_for('sermons') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Sermons</a>
                    <a href="{{ url_for('podcasts') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Podcasts</a>
                    <a href="{{ url_for('live') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Live
                        Stream</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Resources</p>
                    <a href="{{ url_for('resources') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Resources</a>
                    <a href="{{ url_for('give') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Give</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">More</p>
                    <a href="{{ url_for('search') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Search</a>
                    <a href="{{ url_for('archive') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Archive</a>
                </div>
            </div>
        </nav>

        <!-- Fixed Left Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-left hidden lg:block" x-data>
            <div class="dashboard-section">
                <div class="dashboard-title">Quick Search</div>
                <form @submit.prevent="window.location.href='{{ url_for('search') }}?q='+encodeURIComponent($refs.leftSearch.value)">
                    <input x-ref="leftSearch" type="search" placeholder="Search site..."
                        class="w-full px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none"
                        autocomplete="off">
                </form>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Quick Links</div>
                <div class="quick-links-grid">
                    <a href="{{ url_for('index') }}"><i class="fa-solid fa-house"></i><span>Home</span></a>
                    <a href="{{ url_for('highlights') }}"><i class="fa-solid fa-star"></i><span>Highlights</span></a>
                    <a href="{{ url_for('events') }}"><i class="fa-solid fa-calendar-days"></i><span>Events</span></a>
                    <a href="{{ url_for('announcements') }}"><i class="fa-solid fa-bullhorn"></i><span>News</span></a>
                    <a href="{{ url_for('sermons') }}"><i class="fa-solid fa-book-bible"></i><span>Sermons</span></a>
                    <a href="{{ url_for('podcasts') }}"><i class="fa-solid fa-podcast"></i><span>Podcasts</span></a>
                    <a href="{{ url_for('search') }}"><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></a>
                    <a href="{{ url_for('archive') }}"><i class="fa-solid fa-box-archive"></i><span>Archive</span></a>
                    <a href="{{ url_for('give') }}"><i class="fa-solid fa-hand-holding-heart"></i><span>Give</span></a>
                    <a href="{{ url_for('contact') }}"><i class="fa-solid fa-envelope"></i><span>Contact</span></a>
                </div>
            </div>
            <div class="dashboard-section customize-section">
                <div class="dashboard-title">Customize</div>
                <div class="flex flex-col gap-2 text-white/90">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.compact"
                            @change="$store.dash.compact = !$store.dash.compact; $store.dash.save()">
                        <span>Compact mode</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.showService"
                            @change="$store.dash.showService = !$store.dash.showService; $store.dash.save()">
                        <span>Show Sunday Service</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="accent-blue-600"
                            :checked="$store.dash.showAdminCTA"
                            @change="$store.dash.showAdminCTA = !$store.dash.showAdminCTA; $store.dash.save()">
                        <span>Show Admin actions</span>
                    </label>
                    </div>
                <div class="mt-3" x-show="$store.dash.showAdminCTA">
                    <a href="/admin" class="glass-button w-full block text-center">Admin Login</a>
                </div>
            </div>
        </aside>

        <!-- Fixed Right Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-right hidden lg:block" :class="$store.dash.compact ? 'text-sm' : ''">
            <div class="dashboard-section">
                <div class="dashboard-title">Account</div>
                <div class="text-white/90" x-data>
                    <template x-if="$store.dash.userName">
                        <div class="flex items-center justify-between gap-2 text-sm">
                            <span class="truncate">Hi, <strong x-text="$store.dash.userName"></strong></span>
                            <button class="glass-button px-2 py-1 text-xs" @click="$store.dash.userName=''; $store.dash.save()">Sign out</button>
                        </div>
                    </template>
                    <template x-if="!$store.dash.userName">
                        <div class="flex items-center justify-between gap-2">
                            <input x-ref="userInput" type="text" placeholder="Your name"
                                   class="px-2 py-1 rounded-md bg-white/80 text-gray-800 focus:outline-none text-sm"
                                   style="min-width: 0; width: 65%;">
                            <button class="glass-button px-2 py-1 text-xs" @click="$store.dash.userName=$refs.userInput.value.trim(); $store.dash.save()">Sign in</button>
                        </div>
                    </template>
                    <div class="mt-2" x-show="$store.dash.showAdminCTA">
                        <a href="/admin" class="glass-button w-full block text-center text-sm py-2">Admin Login</a>
                    </div>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Now</div>
                <div class="dashboard-note">
                    <div id="liveClock" class="text-white text-lg font-semibold"></div>
                    <div id="liveDate" class="text-white/80 text-sm mt-1"></div>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Weather ‚Äî New Haven</div>
                <div class="dashboard-note">
                    <div id="weatherNow" class="text-white text-lg font-semibold"></div>
                    <div id="weatherHiLo" class="text-white/80 text-sm mt-1"></div>
                    <div id="weatherDesc" class="text-white/70 text-xs mt-1"></div>
                </div>
            </div>
            <div class="dashboard-section" x-show="$store.dash.showService">
                <div class="dashboard-title">Sunday Service</div>
                <div class="dashboard-note">
                    10:30am Worship ‚Ä¢ 135 Whitney Ave
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Stay Connected</div>
                <ul class="dashboard-list">
                    <li><a href="https://www.instagram.com/cpcnewhaven" target="_blank" class="dashboard-link" title="Instagram"><i class="fa-brands fa-instagram"></i></a></li>
                    <li><a href="https://www.youtube.com/@cpcnewhaven" target="_blank" class="dashboard-link" title="YouTube"><i class="fa-brands fa-youtube"></i></a></li>
                    <li><a href="{{ url_for('contact') }}" class="dashboard-link" title="Contact"><i class="fa-solid fa-envelope"></i></a></li>
                </ul>
            </div>
            <div class="dashboard-section" x-show="$store.dash.showAdminCTA">
                <div class="dashboard-title">Manage Content</div>
                <div class="text-white/90 mb-2">Sign in to post highlights, edit events, and manage media.</div>
                <a href="/admin" class="glass-button w-full block text-center">Sign in to Admin</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="pt-8 md:pt-24 pb-20 dashboard-main">
            <div class="dashboard-panel">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Footer Ticker (announcements/highlights) -->
        <div class="footer-ticker">
            <div class="footer-ticker-inner">
                <div class="ticker-viewport">
                    <div class="ticker-content" id="footerTickerTrack">
                        <!-- Filled by JS -->
                    </div>
                </div>
                <div class="footer-meta">
                    <span id="footerNext">Next: Sunday 10:30am</span>
                    <span class="sep">‚Ä¢</span>
                    <span id="footerClock"></span>
                    <span class="sep">‚Ä¢</span>
                    <span id="footerDate"></span>
                </div>
                </div>
            </div>
        <!-- Start menu dock removed; footer ticker now carries meta -->

        <!-- Footer removed in favor of dashboard dock/meta -->
        <footer class="hidden"></footer>

        <!-- Keep all your existing JavaScript files -->
        <script
            src="{{ url_for('static', filename='js/dynamic-banner.js') }}"></script>
        <script
            src="{{ url_for('static', filename='js/background-parallax-magic.js') }}"></script>

        <!-- Dropdown Navigation JavaScript -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle dropdown clicks
            document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const dropdown = this.closest('.nav-dropdown');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    const isHidden = menu.classList.contains('hidden');
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                    
                    // Toggle current dropdown
                    if (isHidden) {
                        menu.classList.remove('hidden');
                        dropdown.classList.add('active');
                    } else {
                        menu.classList.add('hidden');
                        dropdown.classList.remove('active');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                    document.querySelectorAll('.nav-dropdown').forEach(d => {
                        d.classList.remove('active');
                    });
                }
            });
        });
        </script>

        <!-- Dashboard Settings Store -->
        <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('dash', {
                compact: JSON.parse(localStorage.getItem('dash_compact') || 'false'),
                showQuickLinks: JSON.parse(localStorage.getItem('dash_showQuickLinks') || 'true'),
                showService: JSON.parse(localStorage.getItem('dash_showService') || 'true'),
                showAdminCTA: JSON.parse(localStorage.getItem('dash_showAdminCTA') || 'false'),
                userName: localStorage.getItem('dash_userName') || '',
                save() {
                    localStorage.setItem('dash_compact', JSON.stringify(this.compact));
                    localStorage.setItem('dash_showQuickLinks', JSON.stringify(this.showQuickLinks));
                    localStorage.setItem('dash_showService', JSON.stringify(this.showService));
                    localStorage.setItem('dash_showAdminCTA', JSON.stringify(this.showAdminCTA));
                    localStorage.setItem('dash_userName', this.userName || '');
                }
            });
        });
        </script>

        <!-- Live Clock -->
        <script>
        (function() {
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                const t = document.getElementById('liveClock');
                const d = document.getElementById('liveDate');
                const ft = document.getElementById('footerClock');
                const fd = document.getElementById('footerDate');
                if (t) t.textContent = time;
                if (d) d.textContent = date;
                if (ft) ft.textContent = time;
                if (fd) fd.textContent = date;
            }
            updateClock();
            setInterval(updateClock, 1000 * 30);
        })();
        </script>
        <!-- Footer Ticker Script -->
        <script>
        (function() {
            const track = document.getElementById('footerTickerTrack');
            if (!track) return;
            function sanitize(html) {
                const tmp = document.createElement('div');
                tmp.textContent = html;
                return tmp.innerHTML;
            }
            function truncate(text, max) {
                if (!text) return '';
                const t = text.trim();
                return t.length > max ? t.slice(0, max - 1) + '‚Ä¶' : t;
            }
            async function loadItems() {
                let items = [];
                try {
                    const r = await fetch('/api/highlights');
                    if (r.ok) {
                        const data = await r.json();
                        items = (data.announcements || []).filter(a => a && (a.active === true || a.active === "true"));
                    }
                } catch(e) {}
                if (!items.length) {
                    // Fallback blurbs
                    items = [
                        { type: 'News', title: 'Welcome to CPC ‚Äî You are loved in Christ.' },
                        { type: 'Event', title: 'Sunday Worship ¬∑ 10:30am ¬∑ 135 Whitney Ave' },
                        { type: 'Featured', title: 'Community Dinner ¬∑ Wednesday 6pm' }
                    ];
                }
                const parts = items.slice(0, 12).map(it => {
                    const type = sanitize(it.type || 'Update');
                    const title = sanitize(truncate(it.title || it.description || '', 120));
                    return `<span class="ticker-item"><span class="badge">${type}</span><span>${title}</span></span>`;
                });
                // Duplicate content to enable seamless marquee
                track.innerHTML = parts.concat(parts).join('<span class="ticker-item">‚Ä¢</span>');
            }
            loadItems();
        })();
        </script>
        <!-- Weather (New Haven) -->
        <script>
        (function() {
            const elNow = document.getElementById('weatherNow');
            const elHiLo = document.getElementById('weatherHiLo');
            const elDesc = document.getElementById('weatherDesc');
            if (!elNow || !elHiLo || !elDesc) return;
            const url = 'https://api.open-meteo.com/v1/forecast?latitude=41.31&longitude=-72.92&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=America%2FNew_York&temperature_unit=fahrenheit';
            function codeToDesc(c) {
                if (c === 0) return 'Clear sky';
                if (c === 1 || c === 2 || c === 3) return 'Partly cloudy';
                if (c === 45 || c === 48) return 'Fog';
                if (c >= 51 && c <= 57) return 'Drizzle';
                if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'Rain';
                if (c >= 71 && c <= 77) return 'Snow';
                if (c >= 95) return 'Thunderstorms';
                return 'Weather';
            }
            function codeToIcon(c) {
                if (c === 0) return '‚òÄÔ∏è';
                if (c === 1) return 'üå§Ô∏è';
                if (c === 2 || c === 3) return '‚õÖÔ∏è';
                if (c === 45 || c === 48) return 'üå´Ô∏è';
                if (c >= 51 && c <= 57) return 'üå¶Ô∏è';
                if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'üåßÔ∏è';
                if (c >= 71 && c <= 77) return '‚ùÑÔ∏è';
                if (c >= 95) return '‚õàÔ∏è';
                return 'üå°Ô∏è';
            }
            async function loadWeather() {
                try {
                    const r = await fetch(url, { cache: 'no-store' });
                    if (!r.ok) return;
                    const d = await r.json();
                    const t = Math.round((d.current && d.current.temperature_2m) || 0);
                    const c = (d.current && d.current.weather_code) || 0;
                    const hi = Math.round((d.daily && d.daily.temperature_2m_max && d.daily.temperature_2m_max[0]) || t);
                    const lo = Math.round((d.daily && d.daily.temperature_2m_min && d.daily.temperature_2m_min[0]) || t);
                    elNow.textContent = codeToIcon(c) + ' ' + t + '¬∞F';
                    elHiLo.textContent = 'H ' + hi + '¬∞ / L ' + lo + '¬∞';
                    elDesc.textContent = codeToDesc(c);
                } catch (e) {
                    // Fallback
                    elNow.textContent = 'üå°Ô∏è ‚Äî';
                    elHiLo.textContent = '';
                    elDesc.textContent = 'Weather unavailable';
                }
            }
            loadWeather();
            setInterval(loadWeather, 1000 * 60 * 15); // refresh every 15 minutes
        })();
        </script>

        {% block scripts %}{% endblock %}

    </body>
</html>
