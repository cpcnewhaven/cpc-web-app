<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="theme-color" content="#0052a3">
        <title>{% block title %}CPC New Haven{% endblock %}</title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Unified Stylesheet -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}">

        <!-- Alpine.js for reactive components -->
        <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
            defer></script>

        <!-- Papa Parse for CSV parsing if needed -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

        {% block head %}{% endblock %}
    </head>
    <body class="theme-blue">
        <!-- Top yellow bar for weather, parking, and other alerts (admin: check "Show in top bar" on an announcement) -->
        <div id="topAlertBar" class="top-alert-bar" style="display: none;" role="alert">
            <div class="top-alert-bar-inner">
                <span id="topAlertBarContent"></span>
                <button type="button" id="topAlertBarClose" class="top-alert-bar-close" aria-label="Dismiss">√ó</button>
            </div>
        </div>
        <!-- Scroll Progress Bar -->
        <div class="scroll-progress-bar" id="scrollProgressBar"></div>

        <!-- Warning Banner (legacy, kept for dynamic-banner.js if needed) -->
        <div id="warningBanner" class="warning-banner"
            style="display: none;"></div>

        <!-- Desktop Navigation -->
        <nav
            class="top-nav hidden md:flex w-full max-w-6xl mx-auto rounded-lg py-2.5 px-5 items-center fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); border-bottom: 1px solid rgba(255,255,255,0.35); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo absolute left-5">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <ul class="flex items-center gap-2 mx-auto">
                <li><a href="{{ url_for('index') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">Home</a></li>
                <li><a href="{{ url_for('about') }}"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm">About</a></li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Community
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('highlights') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Highlights</a></li>
                        <li><a href="{{ url_for('events') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Events</a></li>
                        <li><a href="{{ url_for('announcements') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Announcements</a></li>
                        <li><a href="{{ url_for('community') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Community</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Media
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('media') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Gallery</a></li>
                        <li><a href="{{ url_for('sermons') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Sermons</a></li>
                        <li><a href="{{ url_for('podcasts') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Podcasts</a></li>
                        <li><a href="{{ url_for('teaching_series') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Teaching Series</a></li>
                        <li><a href="{{ url_for('live') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Live
                                Stream <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(255,0,0,0.2); color:#fff; border:1px solid rgba(255,255,255,0.25);">LIVE</span></a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">Resources
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('resources') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Resources</a></li>
                        <li><a href="{{ url_for('give') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Give</a></li>
                    </ul>
                </li>
                <li class="relative nav-dropdown">
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">More
                        <i class="fas fa-chevron-down text-xs"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full left-0 mt-2 rounded-lg shadow-lg py-2 min-w-[200px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li><a href="{{ url_for('search') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Search</a></li>
                        <li><a href="{{ url_for('archive') }}"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Archive</a></li>
                        <li><a href="/admin/dashboard/"
                                class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10">Admin</a></li>
                    </ul>
                </li>
                <!-- Settings Gear -->
                <li class="relative nav-dropdown" x-data>
                    <a href="#"
                        class="text-white hover:text-blue-200 font-medium px-3 py-2 rounded text-sm dropdown-toggle flex items-center gap-1">
                        <i class="fas fa-cog"></i></a>
                    <ul
                        class="dropdown-menu absolute top-full right-0 mt-2 rounded-lg shadow-lg py-3 px-3 min-w-[220px] hidden backdrop-blur-lg"
                        style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                        <li class="px-1 pb-2 mb-2 border-b border-white/20">
                            <span class="text-white/70 text-xs uppercase tracking-wider font-semibold">Layout</span>
                        </li>
                        <li class="flex items-center justify-between py-1.5 px-1">
                            <span class="text-white text-sm">Left Panel</span>
                            <button class="px-3 py-1 rounded text-xs font-medium transition-all"
                                :class="$store.dash.showLeftSidebar ? 'bg-blue-500 text-white' : 'bg-white/20 text-white/70'"
                                @click="$store.dash.showLeftSidebar = !$store.dash.showLeftSidebar; $store.dash.save()"
                                x-text="$store.dash.showLeftSidebar ? 'On' : 'Off'"></button>
                        </li>
                        <li class="flex items-center justify-between py-1.5 px-1">
                            <span class="text-white text-sm">Right Panel</span>
                            <button class="px-3 py-1 rounded text-xs font-medium transition-all"
                                :class="$store.dash.showRightSidebar ? 'bg-blue-500 text-white' : 'bg-white/20 text-white/70'"
                                @click="$store.dash.showRightSidebar = !$store.dash.showRightSidebar; $store.dash.save()"
                                x-text="$store.dash.showRightSidebar ? 'On' : 'Off'"></button>
                        </li>
                        <li class="px-1 pt-2 mt-2 border-t border-white/20 pb-2 mb-2 border-b border-white/20">
                            <span class="text-white/70 text-xs uppercase tracking-wider font-semibold">Theme</span>
                        </li>
                        <li class="flex items-center justify-between py-1.5 px-1">
                            <span class="text-white text-sm">Color</span>
                            <button class="px-3 py-1 rounded text-xs font-medium transition-all bg-white/20 text-white flex items-center gap-1.5"
                                @click="$store.dash.theme = $store.dash.theme === 'blue' ? 'white' : 'blue'; $store.dash.save(); $store.dash.applyTheme()">
                                <i class="fa-solid text-xs" :class="$store.dash.theme === 'blue' ? 'fa-sun' : 'fa-moon'"></i>
                                <span x-text="$store.dash.theme === 'blue' ? 'Light' : 'Dark'"></span>
                            </button>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Mobile Navigation -->
        <nav x-data="{ open: false }"
            class="top-nav flex md:hidden w-full max-w-6xl mx-auto rounded-lg py-2.5 px-4 items-center justify-between fixed top-5 left-1/2 transform -translate-x-1/2 z-50 backdrop-blur-lg"
            style="background: rgba(0, 50, 120, 0.25); border: 1px solid rgba(0, 50, 120, 0.4); border-bottom: 1px solid rgba(255,255,255,0.35); box-shadow: 0 8px 32px rgba(0, 50, 120, 0.3);">
            <div class="nav-logo">
                <a href="{{ url_for('index') }}">
                    <img src="https://cpcnewhaven.org/assets/CPC_LOGO_24.png"
                        alt="CPC New Haven"
                        class="h-10 filter brightness-0 invert">
                </a>
            </div>
            <button @click="open = !open"
                class="text-3xl text-white">‚ò∞</button>
            <div x-show="open" x-transition
                class="absolute top-full left-0 right-0 rounded-lg shadow-lg mt-2 space-y-2 p-4 backdrop-blur-lg"
                style="background: rgba(0, 50, 120, 0.95); border: 1px solid rgba(0, 50, 120, 0.4);">
                <a href="{{ url_for('index') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">Home</a>
                <a href="{{ url_for('about') }}"
                    class="block text-white hover:text-blue-200 font-medium py-2">About</a>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Community</p>
                    <a href="{{ url_for('highlights') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Highlights</a>
                    <a href="{{ url_for('events') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Events</a>
                    <a href="{{ url_for('announcements') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Announcements</a>
                    <a href="{{ url_for('community') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Community</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Media</p>
                    <a href="{{ url_for('media') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Gallery</a>
                    <a href="{{ url_for('sermons') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Sermons</a>
                    <a href="{{ url_for('podcasts') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Podcasts</a>
                    <a href="{{ url_for('teaching_series') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Teaching Series</a>
                    <a href="{{ url_for('live') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Live
                        Stream</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                    <p
                        class="text-sm font-semibold text-white text-opacity-70 mb-2">Resources</p>
                    <a href="{{ url_for('resources') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Resources</a>
                    <a href="{{ url_for('give') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Give</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2">
                        <p
                            class="text-sm font-semibold text-white text-opacity-70 mb-2">More</p>
                    <a href="{{ url_for('search') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Search</a>
                    <a href="{{ url_for('archive') }}"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Archive</a>
                    <a href="/admin/dashboard/"
                        class="block text-white hover:text-blue-200 font-medium py-1 pl-4">Admin</a>
                </div>
                <div class="border-t border-white border-opacity-20 pt-2 mt-2" x-data>
                    <p class="text-sm font-semibold text-white text-opacity-70 mb-2"><i class="fas fa-cog mr-1"></i> Settings</p>
                    <div class="flex items-center justify-between py-1 pl-4 pr-2">
                        <span class="text-white text-sm">Left Panel</span>
                        <button class="px-3 py-1 rounded text-xs font-medium"
                            :class="$store.dash.showLeftSidebar ? 'bg-blue-500 text-white' : 'bg-white/20 text-white/70'"
                            @click="$store.dash.showLeftSidebar = !$store.dash.showLeftSidebar; $store.dash.save()"
                            x-text="$store.dash.showLeftSidebar ? 'On' : 'Off'"></button>
                    </div>
                    <div class="flex items-center justify-between py-1 pl-4 pr-2">
                        <span class="text-white text-sm">Right Panel</span>
                        <button class="px-3 py-1 rounded text-xs font-medium"
                            :class="$store.dash.showRightSidebar ? 'bg-blue-500 text-white' : 'bg-white/20 text-white/70'"
                            @click="$store.dash.showRightSidebar = !$store.dash.showRightSidebar; $store.dash.save()"
                            x-text="$store.dash.showRightSidebar ? 'On' : 'Off'"></button>
                    </div>
                    <div class="flex items-center justify-between py-1 pl-4 pr-2">
                        <span class="text-white text-sm">Theme</span>
                        <button class="px-3 py-1 rounded text-xs font-medium bg-white/20 text-white flex items-center gap-1"
                            @click="$store.dash.theme = $store.dash.theme === 'blue' ? 'white' : 'blue'; $store.dash.save(); $store.dash.applyTheme()">
                            <i class="fa-solid text-xs" :class="$store.dash.theme === 'blue' ? 'fa-sun' : 'fa-moon'"></i>
                            <span x-text="$store.dash.theme === 'blue' ? 'Light' : 'Dark'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Fixed Left Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-left hidden lg:block" x-data x-show="$store.dash.showLeftSidebar">
            <div class="dashboard-section">
                <div class="dashboard-title">Quick Search</div>
                <form @submit.prevent="window.location.href='{{ url_for('search') }}?q='+encodeURIComponent($refs.leftSearch.value)">
                    <input x-ref="leftSearch" type="search" placeholder="Search site..."
                        class="w-full px-3 py-2 rounded-md bg-white/80 text-gray-800 focus:outline-none"
                        autocomplete="off">
                </form>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Quick Links</div>
                <div class="quick-links-grid">
                    <a href="{{ url_for('index') }}"><i class="fa-solid fa-house"></i><span>Home</span></a>
                    <a href="{{ url_for('live') }}"><i class="fa-solid fa-video"></i><span>Live Stream</span></a>
                    <a href="{{ url_for('highlights') }}"><i class="fa-solid fa-star"></i><span>Highlights</span></a>
                    <a href="{{ url_for('events') }}"><i class="fa-solid fa-calendar-days"></i><span>Events</span></a>
                    <a href="{{ url_for('announcements') }}"><i class="fa-solid fa-bullhorn"></i><span>News</span></a>
                    <a href="{{ url_for('sermons') }}"><i class="fa-solid fa-book-bible"></i><span>Sermons</span></a>
                    <a href="{{ url_for('podcasts') }}"><i class="fa-solid fa-podcast"></i><span>Podcasts</span></a>
                    <a href="{{ url_for('teaching_series') }}"><i class="fa-solid fa-book-open"></i><span>Teaching Series</span></a>
                    <a href="{{ url_for('search') }}"><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></a>
                    <a href="{{ url_for('archive') }}"><i class="fa-solid fa-box-archive"></i><span>Archive</span></a>
                    <a href="{{ url_for('give') }}"><i class="fa-solid fa-hand-holding-heart"></i><span>Give</span></a>
                    <a href="{{ url_for('contact') }}"><i class="fa-solid fa-envelope"></i><span>Contact</span></a>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Account</div>
                <div class="text-white/90" x-data>
                    <template x-if="$store.dash.userName">
                        <div class="flex items-center justify-between gap-2 text-sm">
                            <span class="truncate">Hi, <strong x-text="$store.dash.userName"></strong></span>
                            <button class="glass-button px-2 py-1 text-xs" @click="$store.dash.userName=''; $store.dash.save()">Sign out</button>
                        </div>
                    </template>
                    <template x-if="!$store.dash.userName">
                        <div class="flex items-center justify-between gap-2">
                            <input x-ref="userInput" type="text" placeholder="Your name"
                                   class="px-2 py-1 rounded-md bg-white/80 text-gray-800 focus:outline-none text-sm"
                                   style="min-width: 0; width: 65%;">
                            <button class="glass-button px-2 py-1 text-xs" @click="$store.dash.userName=$refs.userInput.value.trim(); $store.dash.save()">Sign in</button>
                        </div>
                    </template>
                    <div class="mt-2" x-show="$store.dash.showAdminCTA">
                        <a href="/admin/dashboard/" class="glass-button w-full block text-center text-sm py-2">Admin</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Fixed Right Dashboard (Desktop) -->
        <aside class="dashboard-sidebar dashboard-right hidden lg:block" :class="$store.dash.compact ? 'text-sm' : ''" x-show="$store.dash.showRightSidebar">
            <div class="dashboard-section" id="luke-chapter-section">
                <div class="dashboard-title" style="border-left: none;">Current Teaching Series</div>
                <div class="dashboard-note" id="luke-chapter-content">
                    <div class="study-reference">Luke 12:35-59</div>
                    <div class="study-title">A Life of Readiness</div>
                    <div class="study-date">Rev. Jerry Ornelas ‚Ä¢ 1.25.26</div>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Now</div>
                <div class="dashboard-note">
                    <div id="liveClock" class="text-white text-lg font-semibold"></div>
                    <div id="liveDate" class="text-white/80 text-sm mt-1"></div>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-title">Weather ‚Äî New Haven</div>
                <div class="dashboard-note">
                    <div id="weatherNow" class="text-white text-lg font-semibold"></div>
                    <div id="weatherHiLo" class="text-white/80 text-sm mt-1"></div>
                    <div id="weatherDesc" class="text-white/70 text-xs mt-1"></div>
                </div>
            </div>
            <div class="dashboard-section" x-show="$store.dash.showService">
                <div class="dashboard-title">Sunday Service</div>
                <div class="dashboard-note">
                    10:30am Worship ‚Ä¢ 135 Whitney Ave
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="pt-8 md:pt-24 pb-20 md:pb-20 mobile-main-content dashboard-main">
            <div class="dashboard-panel">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Mobile Bottom Navigation Bar -->
        <nav class="mobile-bottom-nav md:hidden">
            <a href="{{ url_for('index') }}" class="mobile-nav-item" data-route="index">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </a>
            <a href="{{ url_for('live') }}" class="mobile-nav-item" data-route="live">
                <i class="fa-solid fa-video"></i>
                <span>Live</span>
            </a>
            <a href="{{ url_for('sermons') }}" class="mobile-nav-item" data-route="sermons">
                <i class="fa-solid fa-book-bible"></i>
                <span>Sermons</span>
            </a>
            <a href="{{ url_for('events') }}" class="mobile-nav-item" data-route="events">
                <i class="fa-solid fa-calendar-days"></i>
                <span>Events</span>
            </a>
            <a href="{{ url_for('search') }}" class="mobile-nav-item" data-route="search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>Search</span>
            </a>
        </nav>

        <!-- Footer Ticker (announcements/highlights) -->
        <div class="footer-ticker">
            <div class="footer-ticker-inner">
                <div class="ticker-viewport">
                    <div class="ticker-content" id="footerTickerTrack">
                        <!-- Filled by JS -->
                    </div>
                </div>
                <div class="footer-meta">
                    <span id="footerNext" class="hidden md:inline">Next: Sunday 10:30am</span>
                    <span class="sep hidden md:inline">‚Ä¢</span>
                    <span id="footerClock"></span>
                    <span class="sep">‚Ä¢</span>
                    <span id="footerDate"></span>
                </div>
                </div>
            </div>
        <!-- Start menu dock removed; footer ticker now carries meta -->

        <!-- Footer removed in favor of dashboard dock/meta -->
        <footer class="hidden"></footer>

        <!-- Keep all your existing JavaScript files -->
        <script
            src="{{ url_for('static', filename='js/dynamic-banner.js') }}"></script>
        <script
            src="{{ url_for('static', filename='js/background-parallax-magic.js') }}"></script>

        <!-- Dropdown Navigation JavaScript -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle dropdown clicks
            document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const dropdown = this.closest('.nav-dropdown');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    const isHidden = menu.classList.contains('hidden');
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                    
                    // Toggle current dropdown
                    if (isHidden) {
                        menu.classList.remove('hidden');
                        dropdown.classList.add('active');
                    } else {
                        menu.classList.add('hidden');
                        dropdown.classList.remove('active');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => {
                        m.classList.add('hidden');
                    });
                    document.querySelectorAll('.nav-dropdown').forEach(d => {
                        d.classList.remove('active');
                    });
                }
            });
        });
        </script>

        <!-- Dashboard Settings Store -->
        <script>
        // Apply theme immediately on page load (before Alpine initializes)
        (function() {
            const savedTheme = localStorage.getItem('dash_theme') || 'blue';
            // Default: left sidebar ON, right sidebar OFF
            const leftSidebarStored = localStorage.getItem('dash_showLeftSidebar');
            const rightSidebarStored = localStorage.getItem('dash_showRightSidebar');
            const showLeftSidebar = leftSidebarStored !== null ? JSON.parse(leftSidebarStored) : true;
            const showRightSidebar = rightSidebarStored !== null ? JSON.parse(rightSidebarStored) : false;
            const leftSidebarMax = JSON.parse(localStorage.getItem('dash_leftSidebarMax') || 'false');
            const rightSidebarMax = JSON.parse(localStorage.getItem('dash_rightSidebarMax') || 'false');
            if (savedTheme === 'white') {
                document.body.classList.add('theme-white');
                document.body.classList.remove('theme-blue');
            } else {
                document.body.classList.add('theme-blue');
                document.body.classList.remove('theme-white');
            }
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.classList.toggle('sidebar-left-hidden', !showLeftSidebar);
            document.body.classList.toggle('sidebar-right-hidden', !showRightSidebar);
            document.body.classList.toggle('sidebar-left-max', leftSidebarMax);
            document.body.classList.toggle('sidebar-right-max', rightSidebarMax);
        })();
        
        document.addEventListener('alpine:init', () => {
            Alpine.store('dash', {
                compact: JSON.parse(localStorage.getItem('dash_compact') || 'false'),
                showQuickLinks: JSON.parse(localStorage.getItem('dash_showQuickLinks') || 'true'),
                showService: JSON.parse(localStorage.getItem('dash_showService') || 'true'),
                showAdminCTA: JSON.parse(localStorage.getItem('dash_showAdminCTA') || 'false'),
                // Default: left sidebar ON, right sidebar OFF
                showLeftSidebar: localStorage.getItem('dash_showLeftSidebar') !== null
                    ? JSON.parse(localStorage.getItem('dash_showLeftSidebar'))
                    : true,
                showRightSidebar: localStorage.getItem('dash_showRightSidebar') !== null
                    ? JSON.parse(localStorage.getItem('dash_showRightSidebar'))
                    : false,
                leftSidebarMax: JSON.parse(localStorage.getItem('dash_leftSidebarMax') || 'false'),
                rightSidebarMax: JSON.parse(localStorage.getItem('dash_rightSidebarMax') || 'false'),
                userName: localStorage.getItem('dash_userName') || '',
                theme: localStorage.getItem('dash_theme') || 'blue',
                save() {
                    localStorage.setItem('dash_compact', JSON.stringify(this.compact));
                    localStorage.setItem('dash_showQuickLinks', JSON.stringify(this.showQuickLinks));
                    localStorage.setItem('dash_showService', JSON.stringify(this.showService));
                    localStorage.setItem('dash_showAdminCTA', JSON.stringify(this.showAdminCTA));
                    localStorage.setItem('dash_showLeftSidebar', JSON.stringify(this.showLeftSidebar));
                    localStorage.setItem('dash_showRightSidebar', JSON.stringify(this.showRightSidebar));
                    localStorage.setItem('dash_leftSidebarMax', JSON.stringify(this.leftSidebarMax));
                    localStorage.setItem('dash_rightSidebarMax', JSON.stringify(this.rightSidebarMax));
                    localStorage.setItem('dash_userName', this.userName || '');
                    localStorage.setItem('dash_theme', this.theme);
                    this.applyLayout();
                },
                applyLayout() {
                    document.body.classList.toggle('sidebar-left-hidden', !this.showLeftSidebar);
                    document.body.classList.toggle('sidebar-right-hidden', !this.showRightSidebar);
                    document.body.classList.toggle('sidebar-left-max', this.leftSidebarMax);
                    document.body.classList.toggle('sidebar-right-max', this.rightSidebarMax);
                },
                applyTheme() {
                    document.documentElement.setAttribute('data-theme', this.theme);
                    if (this.theme === 'white') {
                        document.body.classList.add('theme-white');
                        document.body.classList.remove('theme-blue');
                    } else {
                        document.body.classList.add('theme-blue');
                        document.body.classList.remove('theme-white');
                    }
                }
            });
            Alpine.store('dash').applyLayout();
        });
        </script>

        <!-- Live Clock -->
        <script>
        (function() {
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                const t = document.getElementById('liveClock');
                const d = document.getElementById('liveDate');
                const ft = document.getElementById('footerClock');
                const fd = document.getElementById('footerDate');
                if (t) t.textContent = time;
                if (d) d.textContent = date;
                if (ft) ft.textContent = time;
                if (fd) fd.textContent = date;
            }
            updateClock();
            setInterval(updateClock, 1000 * 30);
        })();
        </script>
        <!-- Top Alert Bar (banner announcements) -->
        <script>
        (function() {
            const bar = document.getElementById('topAlertBar');
            const content = document.getElementById('topAlertBarContent');
            const closeBtn = document.getElementById('topAlertBarClose');
            if (!bar || !content) return;
            if (sessionStorage.getItem('topAlertBarDismissed') === '1') return;
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            fetch('/api/banner-announcements')
                .then(function(r) { return r.ok ? r.json() : []; })
                .then(function(data) {
                    const list = (data && data.announcements) ? data.announcements : [];
                    if (list.length === 0) return;
                    const parts = list.map(function(a) {
                        const title = escapeHtml(a.title || '');
                        const desc = (a.description || '').trim();
                        const descShort = desc.length > 120 ? desc.slice(0, 117) + '‚Ä¶' : desc;
                        const type = escapeHtml((a.type || 'Alert').replace(/_/g, ' '));
                        if (descShort) return '<span class="top-alert-item"><strong>' + title + '</strong> ‚Äî ' + escapeHtml(descShort) + '</span>';
                        return '<span class="top-alert-item"><strong>' + title + '</strong></span>';
                    });
                    content.innerHTML = parts.join('<span class="top-alert-sep"> ¬∑ </span>');
                    bar.style.display = 'block';
                    document.body.classList.add('has-top-alert');
                })
                .catch(function() {});
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    bar.style.display = 'none';
                    document.body.classList.remove('has-top-alert');
                    sessionStorage.setItem('topAlertBarDismissed', '1');
                });
            }
        })();
        </script>
        <!-- Footer Ticker Script -->
        <script>
        (function() {
            const track = document.getElementById('footerTickerTrack');
            if (!track) return;
            function sanitize(html) {
                const tmp = document.createElement('div');
                tmp.textContent = html;
                return tmp.innerHTML;
            }
            function truncate(text, max) {
                if (!text) return '';
                const t = text.trim();
                return t.length > max ? t.slice(0, max - 1) + '‚Ä¶' : t;
            }
            async function loadItems() {
                let items = [];
                try {
                    const r = await fetch('/api/highlights');
                    if (r.ok) {
                        const data = await r.json();
                        items = (data.announcements || []).filter(a => a && (a.active === true || a.active === "true"));
                    }
                } catch(e) {}
                if (!items.length) {
                    // Fallback blurbs
                    items = [
                        { type: 'News', title: 'Welcome to CPC ‚Äî You are loved in Christ.' },
                        { type: 'Event', title: 'Sunday Worship ¬∑ 10:30am ¬∑ 135 Whitney Ave' },
                        { type: 'Featured', title: 'Community Dinner ¬∑ Wednesday 6pm' }
                    ];
                }
                // Add snow announcement at the beginning
                items.unshift({ type: 'Alert', title: 'No Sunday School or Fellowship Lunch due to snow ‚Ä¢ Regular 10:30a service is on' });
                const parts = items.slice(0, 12).map(it => {
                    const type = sanitize(it.type || 'Update');
                    const title = sanitize(truncate(it.title || it.description || '', 120));
                    const alertClass = (it.type === 'Alert') ? ' alert-item' : '';
                    return `<span class="ticker-item${alertClass}"><span class="badge">${type}</span><span>${title}</span></span>`;
                });
                // Duplicate content to enable seamless marquee
                track.innerHTML = parts.concat(parts).join('<span class="ticker-item">‚Ä¢</span>');
            }
            loadItems();
        })();
        </script>
        <!-- Latest Luke Chapter -->
        <!-- Weather (New Haven) -->
        <script>
        (function() {
            const elNow = document.getElementById('weatherNow');
            const elHiLo = document.getElementById('weatherHiLo');
            const elDesc = document.getElementById('weatherDesc');
            if (!elNow || !elHiLo || !elDesc) return;
            const url = 'https://api.open-meteo.com/v1/forecast?latitude=41.31&longitude=-72.92&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=America%2FNew_York&temperature_unit=fahrenheit';
            function codeToDesc(c) {
                if (c === 0) return 'Clear sky';
                if (c === 1 || c === 2 || c === 3) return 'Partly cloudy';
                if (c === 45 || c === 48) return 'Fog';
                if (c >= 51 && c <= 57) return 'Drizzle';
                if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'Rain';
                if (c >= 71 && c <= 77) return 'Snow';
                if (c >= 95) return 'Thunderstorms';
                return 'Weather';
            }
            function codeToIcon(c) {
                if (c === 0) return '‚òÄÔ∏è';
                if (c === 1) return 'üå§Ô∏è';
                if (c === 2 || c === 3) return '‚õÖÔ∏è';
                if (c === 45 || c === 48) return 'üå´Ô∏è';
                if (c >= 51 && c <= 57) return 'üå¶Ô∏è';
                if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'üåßÔ∏è';
                if (c >= 71 && c <= 77) return '‚ùÑÔ∏è';
                if (c >= 95) return '‚õàÔ∏è';
                return 'üå°Ô∏è';
            }
            async function loadWeather() {
                try {
                    const r = await fetch(url, { cache: 'no-store' });
                    if (!r.ok) return;
                    const d = await r.json();
                    const t = Math.round((d.current && d.current.temperature_2m) || 0);
                    const c = (d.current && d.current.weather_code) || 0;
                    const hi = Math.round((d.daily && d.daily.temperature_2m_max && d.daily.temperature_2m_max[0]) || t);
                    const lo = Math.round((d.daily && d.daily.temperature_2m_min && d.daily.temperature_2m_min[0]) || t);
                    elNow.textContent = codeToIcon(c) + ' ' + t + '¬∞F';
                    elHiLo.textContent = 'H ' + hi + '¬∞ / L ' + lo + '¬∞';
                    elDesc.textContent = codeToDesc(c);
                } catch (e) {
                    // Fallback
                    elNow.textContent = 'üå°Ô∏è ‚Äî';
                    elHiLo.textContent = '';
                    elDesc.textContent = 'Weather unavailable';
                }
            }
            loadWeather();
            setInterval(loadWeather, 1000 * 60 * 15); // refresh every 15 minutes
        })();
        </script>

        {% block scripts %}{% endblock %}

        <!-- Scroll Progress Bar Script -->
        <script>
        (function() {
            const scrollProgressBar = document.getElementById('scrollProgressBar');
            if (!scrollProgressBar) return;
            
            function updateScrollProgress() {
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollableHeight = documentHeight - windowHeight;
                
                if (scrollableHeight <= 0) {
                    scrollProgressBar.style.width = '0%';
                    return;
                }
                
                const scrollProgress = (scrollTop / scrollableHeight) * 100;
                scrollProgressBar.style.width = Math.min(100, Math.max(0, scrollProgress)) + '%';
            }
            
            window.addEventListener('scroll', updateScrollProgress, { passive: true });
            window.addEventListener('resize', updateScrollProgress);
            updateScrollProgress(); // Initial call
        })();
        </script>

        <!-- Mobile Bottom Nav Active State -->
        <script>
        (function() {
            // Get current route from URL
            const currentPath = window.location.pathname;
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            
            // Map routes to data-route values
            const routeMap = {
                '/': 'index',
                '/index': 'index',
                '/live': 'live',
                '/sermons': 'sermons',
                '/events': 'events',
                '/search': 'search'
            };
            
            // Determine current route
            let currentRoute = routeMap[currentPath] || '';
            
            // If no exact match, check if path starts with route
            if (!currentRoute) {
                for (const [path, route] of Object.entries(routeMap)) {
                    if (currentPath.startsWith(path) && path !== '/') {
                        currentRoute = route;
                        break;
                    }
                }
            }
            
            // Set active state
            mobileNavItems.forEach(item => {
                const itemRoute = item.getAttribute('data-route');
                if (itemRoute === currentRoute) {
                    item.classList.add('active');
                }
            });
        })();
        </script>

    </body>
</html>
