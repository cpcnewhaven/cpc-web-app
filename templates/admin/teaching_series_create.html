{% extends 'admin/model/create.html' %}

{% block header_text %}
<h3>Create New Teaching Series</h3>
<div
    style="background: rgba(0, 122, 255, 0.1); border-left: 4px solid var(--cpc-blue); padding: 1rem; margin-top: 1rem; border-radius: 4px; color: var(--text-white);">
    <i class="fas fa-info-circle" style="color: var(--cpc-blue); margin-right: 0.5rem;"></i>
    <strong>Adding Classes:</strong>
    You can add classes (sessions) and upload PDFs directly from this page using the <strong>Teaching Series
        Sessions</strong> section below. When you're done, click <strong>Save & Deploy</strong>.
</div>
{% endblock %}

{% block tail %}
{{ super() }}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Rename "New Sessions" block titles that Flask-Admin auto-generates
        function renameSessionLabels() {
            document.querySelectorAll('legend small').forEach(el => {
                if (el.textContent.includes('New Sessions') || el.textContent.includes('Sessions') || el.textContent.includes('Session')) {
                    el.textContent = el.textContent.replace('Sessions', 'Class').replace('Session', 'Class');
                }
            });
            document.querySelectorAll('th').forEach(el => {
                if (el.textContent.includes('Sessions')) {
                    el.textContent = el.textContent.replace('Sessions', 'Classes');
                }
            });
        }

        // Look for the "Add" button that flask-admin creates for Inline Models.
        // Specifically for TeachingSeriesSession. It'll be inside a container with class .inline-field-list
        const addBtns = document.querySelectorAll('.inline-add-field');
        if (!addBtns || addBtns.length === 0) return;

        // Assuming there's only one inline model (Sessions), we target its container
        const addBtn = addBtns[0];

        // Rename the Flask-Admin default add button
        addBtn.innerHTML = '<i class="fa fa-plus glyphicon glyphicon-plus"></i> Add Class Manually';

        const container = addBtn.closest('.form-group') || addBtn.parentElement;

        // Create the wizard UI
        const wizardMarkup = `
        <div id="sessions-wizard" style="background:rgba(0,122,255,0.05); padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid rgba(0,122,255,0.2);">
            <h4 style="margin-top:0; color:var(--cpc-blue);"><i class="fas fa-magic"></i> Class Setup Wizard</h4>
            <p>How many classes will be in this series? Enter a number to automatically generate the class entry forms.</p>
            <div class="input-group" style="max-width:300px;">
                <input type="number" id="wizard-session-count" class="form-control" min="1" max="50" value="1" placeholder="e.g. 8">
                <span class="input-group-btn">
                    <button class="btn btn-primary" id="wizard-generate-btn" type="button" style="background-color: var(--cpc-blue); border-color: var(--cpc-blue);">Generate Entries</button>
                </span>
            </div>
            <small style="display:block; margin-top:10px; color:#666;">(You can still manually add or remove classes below after generating)</small>
        </div>
    `;

        // Insert wizard before the sessions inline list
        container.insertAdjacentHTML('beforebegin', wizardMarkup);

        document.getElementById('wizard-generate-btn').addEventListener('click', function () {
            const count = parseInt(document.getElementById('wizard-session-count').value, 10) || 1;
            // Click the Flask-Admin exact add button 'count' times
            for (let i = 0; i < count; i++) {
                addBtn.click();
            }

            // Rename the newly generated labels
            setTimeout(renameSessionLabels, 50);

            // Auto-scroll slightly so they see the new fields
            setTimeout(() => {
                window.scrollBy({ top: 300, behavior: 'smooth' });
            }, 100);
        });

        // Rename right away for any existing fields
        renameSessionLabels();

        // 3. Form Submission Tracking - To trigger git push hook
        const form = document.querySelector('form.admin-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                // Let the form submit normally, the backend handles git push
                // No extra javascript required for the git push logic if we handle it in Flask
            });
        }
    });
</script>
{% endblock %}