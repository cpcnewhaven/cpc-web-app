{% extends 'admin/base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script>
(function() {
    function trimWords(text, maxWords) {
        var words = (text || '').trim().split(/\s+/).filter(Boolean);
        return words.slice(0, maxWords).join(' ');
    }
    document.addEventListener('DOMContentLoaded', function() {
        var form = document.querySelector('form');
        if (!form) return;
        var params = new URLSearchParams(window.location.search);
        var isBanner = params.get('banner') === '1';
        var titleInput = form.querySelector('input[name="title"]');
        var bannerTypeInput = form.querySelector('select[name="banner_type"]');
        var descriptionInput = form.querySelector('textarea[name="description"]');

        if (isBanner) {
            var fieldNamesToHide = [
                'type', 'category', 'tag', 'title', 'id', 'active',
                'show_in_banner', 'superfeatured', 'featured_image', 'image_display_type'
            ];
            fieldNamesToHide.forEach(function(name) {
                var input = form.querySelector('[name="' + name + '"]');
                if (!input) return;
                var group = input.closest('.form-group');
                if (group) group.style.display = 'none';
            });
            if (bannerTypeInput && !bannerTypeInput.value) {
                bannerTypeInput.value = 'alert';
            }
            if (descriptionInput) {
                descriptionInput.setAttribute('maxlength', '280');
                descriptionInput.setAttribute('placeholder', 'Type the banner message (tweet length).');
                descriptionInput.style.minHeight = '120px';
                var note = document.createElement('div');
                note.className = 'banner-quick-note';
                note.textContent = 'Keep it short and scannable. Title and ID are set automatically.';
                descriptionInput.parentNode.appendChild(note);
                var count = document.createElement('div');
                count.className = 'banner-char-count';
                descriptionInput.parentNode.appendChild(count);
                var updateCount = function() {
                    count.textContent = descriptionInput.value.length + '/280';
                    if (titleInput) {
                        var autoTitle = trimWords(descriptionInput.value, 6);
                        if (autoTitle) {
                            titleInput.value = autoTitle;
                            titleInput.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                };
                descriptionInput.addEventListener('input', updateCount);
                updateCount();
            }
            if (bannerTypeInput) {
                bannerTypeInput.addEventListener('change', function() {});
            }
        }

        // Hide any ID form group so users only see automatic IDs (no builder)
        var idInput = form.querySelector('input[name="id"]');
        if (idInput) {
            var idGroup = idInput.closest('.form-group');
            if (idGroup) idGroup.style.display = 'none';
        }
    });
})();
</script>
<script>
(function() {
    function addBannerMenuItem() {
        var navLinks = document.querySelectorAll('.navbar-nav > li.dropdown');
        if (!navLinks.length) return;
        var target = null;
        navLinks.forEach(function(item) {
            var label = item.querySelector('a');
            if (label && label.textContent.trim().toLowerCase() === 'content') {
                target = item;
            }
        });
        if (!target) return;
        var menu = target.querySelector('.dropdown-menu');
        if (!menu) return;
        if (menu.querySelector('[data-banner-link="1"]')) return;
        var divider = document.createElement('li');
        divider.className = 'divider';
        var item = document.createElement('li');
        var link = document.createElement('a');
        link.setAttribute('href', '{{ url_for('admin_banner_alert_new') }}');
        link.setAttribute('data-banner-link', '1');
        link.innerHTML = '<i class="fas fa-bolt" style="margin-right: 6px;"></i> Banner alerts';
        item.appendChild(link);
        menu.appendChild(divider);
        menu.appendChild(item);
    }
    document.addEventListener('DOMContentLoaded', addBannerMenuItem);
})();
</script>
{% endblock %}

{% block page_body %}
<main class="admin-dashboard-main">
    {{ super() }}
</main>
{% endblock %}

{% block brand %}
<a class="navbar-brand" href="/admin/dashboard/">
    <i class="fas fa-church"></i> CPC Admin
</a>
{% endblock %}

{% block access_control %}
<div style="display: flex; align-items: center; gap: 0.75rem; margin-right: 1rem; flex-wrap: wrap;">
    <span id="adminLastChange" style="color: rgba(255,255,255,0.55); font-size: 0.8rem; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="Loading last change..."></span>
    {% if session.get('username') %}
    <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem;">
        <i class="fas fa-user-circle"></i> {{ session.get('username') }}
    </span>
    {% endif %}
    <a href="/" target="_blank" style="color: var(--text-white); text-decoration: none; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); transition: var(--transition-fast); font-size: 0.85rem;">
        <i class="fas fa-globe"></i> View Site
    </a>
    <a href="{{ url_for('admin_logout') }}" style="color: var(--text-white); text-decoration: none; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); transition: var(--transition-fast); font-size: 0.85rem;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>
{% endblock %}

{% block tail %}
{{ super() }}
<script>
(function() {
    var el = document.getElementById('adminLastChange');
    if (!el) return;
    fetch('/api/admin/last-change')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d && d.type && d.title) {
                el.textContent = 'Last: ' + d.type + ' — ' + d.title + (d.when ? ' (' + d.when + ')' : '');
                el.title = d.type + ': ' + d.title + (d.when ? ' — ' + d.when : '');
            } else {
                el.textContent = 'No recent changes';
            }
        })
        .catch(function() { el.textContent = ''; });
})();
</script>
{% endblock %}
