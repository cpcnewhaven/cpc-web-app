{% extends 'admin/base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script>
(function() {
    function slugify(s) {
        return (s || '').toString().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '').replace(/-+/g, '-').replace(/^-|-$/g, '') || 'item';
    }
    function trimWords(text, maxWords) {
        var words = (text || '').trim().split(/\s+/).filter(Boolean);
        return words.slice(0, maxWords).join(' ');
    }
    document.addEventListener('DOMContentLoaded', function() {
        var idInput = document.querySelector('input[name="id"]');
        if (!idInput || idInput.disabled || idInput.readOnly) return;
        var form = idInput.closest('form');
        if (!form) return;
        var params = new URLSearchParams(window.location.search);
        var isBanner = params.get('banner') === '1';
        var now = new Date();
        var years = [];
        for (var y = now.getFullYear() - 2; y <= now.getFullYear() + 1; y++) years.push(y);
        var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
        var types = [
            ['announcement','Announcement'],['event','Event'],['ongoing','Ongoing'],['sermon','Sermon'],
            ['gallery','Gallery'],['highlight','Highlight'],['weather','Weather'],['parking','Parking'],['alert','Alert'],['special','Special']
        ];
        var categories = [
            ['general','General'],['worship','Worship'],['education','Education'],['fellowship','Fellowship'],
            ['missions','Missions'],['youth','Youth'],['children','Children'],['prayer','Prayer']
        ];
        var slugs = [
            ['','‚Äî optional ‚Äî'],['welcome','welcome'],['lunch','lunch'],['sunday-school','sunday-school'],
            ['worship','worship'],['dinner','dinner'],['prayer','prayer'],['special','special'],['brunch','brunch'],
            ['meeting','meeting'],['class','class'],['service','service'],['retreat','retreat']
        ];
        var panel = document.createElement('div');
        panel.className = 'id-builder-panel';
        panel.innerHTML =
            '<div class="id-builder-title">Build ID from options (no typing)</div>' +
            '<div class="id-builder-row">' +
            '<label>Year</label><select id="idb-year">' + years.map(function(y){ return '<option value="'+y+'"'+(y===now.getFullYear()?' selected':'')+'>'+y+'</option>'; }).join('') + '</select>' +
            '<label>Month</label><select id="idb-month">' + (function(){ var cm = (now.getMonth()+1)<10 ? '0'+(now.getMonth()+1) : ''+(now.getMonth()+1); return months.map(function(m){ return '<option value="'+m+'"'+(m===cm?' selected':'')+'>'+m+'</option>'; }).join(''); })() + '</select>' +
            '<label>Type</label><select id="idb-type">' + types.map(function(t){ return '<option value="'+t[0]+'">'+t[1]+'</option>'; }).join('') + '</select>' +
            '<label>Category</label><select id="idb-cat">' + categories.map(function(c){ return '<option value="'+c[0]+'">'+c[1]+'</option>'; }).join('') + '</select>' +
            '<label>Slug</label><select id="idb-slug">' + slugs.map(function(s){ return '<option value="'+s[0]+'">'+s[1]+'</option>'; }).join('') + '</select>' +
            '<button type="button" class="btn-apply-id" id="idb-apply">Apply as ID</button>' +
            '<span class="id-preview" id="idb-preview"></span></div>';
        if (!isBanner) {
            idInput.parentNode.insertBefore(panel, idInput);
        }
        function buildId() {
            var y = document.getElementById('idb-year').value;
            var m = document.getElementById('idb-month').value;
            var t = document.getElementById('idb-type').value;
            var c = document.getElementById('idb-cat').value;
            var s = document.getElementById('idb-slug').value;
            var id = y + '-' + m + '-' + t + '-' + c;
            if (s) id += '-' + s;
            return id;
        }
        function updatePreview() {
            var el = document.getElementById('idb-preview');
            if (el) el.textContent = '‚Üí ' + buildId();
        }
        if (!isBanner) {
            document.getElementById('idb-apply').addEventListener('click', function() {
                idInput.value = buildId();
                idInput.dispatchEvent(new Event('change', { bubbles: true }));
            });
            ['idb-year','idb-month','idb-type','idb-cat','idb-slug'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', updatePreview);
            });
            updatePreview();
        }
        var titleInput = form.querySelector('input[name="title"]');
        var bannerTypeInput = form.querySelector('select[name="banner_type"]');
        var descriptionInput = form.querySelector('textarea[name="description"]');
        function setBannerIdFromTitle() {
            if (!isBanner) return;
            if (!idInput) return;
            var titleSource = (titleInput && titleInput.value) ? titleInput.value : (descriptionInput ? descriptionInput.value : '');
            var slug = slugify(titleSource);
            if (!slug || slug === 'item') return;
            var typeVal = bannerTypeInput ? bannerTypeInput.value : '';
            var safeType = typeVal ? typeVal : 'alert';
            var month = (now.getMonth() + 1);
            var mm = month < 10 ? '0' + month : '' + month;
            var id = now.getFullYear() + '-' + mm + '-banner-' + safeType + '-' + slug;
            idInput.value = id;
            idInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (isBanner) {
            var fieldNamesToHide = [
                'type',
                'category',
                'tag',
                'title',
                'id',
                'active',
                'show_in_banner',
                'superfeatured',
                'featured_image',
                'image_display_type'
            ];
            fieldNamesToHide.forEach(function(name) {
                var input = form.querySelector('[name="' + name + '"]');
                if (!input) return;
                var group = input.closest('.form-group');
                if (group) group.style.display = 'none';
            });
            if (bannerTypeInput && !bannerTypeInput.value) {
                bannerTypeInput.value = 'alert';
            }
            if (descriptionInput) {
                descriptionInput.setAttribute('maxlength', '280');
                descriptionInput.setAttribute('placeholder', 'Type the banner message (tweet length).');
                descriptionInput.style.minHeight = '120px';
                var note = document.createElement('div');
                note.className = 'banner-quick-note';
                note.textContent = 'Keep it short and scannable. Title and ID are auto-generated.';
                descriptionInput.parentNode.appendChild(note);
                var count = document.createElement('div');
                count.className = 'banner-char-count';
                descriptionInput.parentNode.appendChild(count);
                var updateCount = function() {
                    var len = descriptionInput.value.length;
                    count.textContent = len + '/280';
                    if (titleInput) {
                        var autoTitle = trimWords(descriptionInput.value, 6);
                        if (autoTitle) {
                            titleInput.value = autoTitle;
                            titleInput.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                    setBannerIdFromTitle();
                };
                descriptionInput.addEventListener('input', updateCount);
                updateCount();
            }
            if (bannerTypeInput) {
                bannerTypeInput.addEventListener('change', setBannerIdFromTitle);
            }
            setBannerIdFromTitle();
        }
        if (!isBanner && idInput) {
            var help = document.createElement('div');
            help.className = 'banner-quick-note';
            help.textContent = 'Optional but recommended. Click Generate ID to keep things organized.';
            var genBtn = document.createElement('button');
            genBtn.type = 'button';
            genBtn.className = 'btn btn-default';
            genBtn.style.marginTop = '0.5rem';
            genBtn.textContent = 'Generate ID';
            genBtn.addEventListener('click', function() {
                var title = '';
                if (titleInput && titleInput.value) title = titleInput.value;
                else if (descriptionInput && descriptionInput.value) title = descriptionInput.value;
                var slug = slugify(title);
                var nowLocal = new Date();
                var mm = (nowLocal.getMonth() + 1);
                var mmStr = mm < 10 ? '0' + mm : '' + mm;
                var typeVal = '';
                var typeInput = form.querySelector('select[name="type"]');
                if (typeInput) typeVal = typeInput.value || 'announcement';
                var catVal = '';
                var catInput = form.querySelector('select[name="category"]');
                if (catInput) catVal = catInput.value || 'general';
                idInput.value = nowLocal.getFullYear() + '-' + mmStr + '-' + typeVal + '-' + catVal + '-' + slug;
                idInput.dispatchEvent(new Event('change', { bubbles: true }));
            });
            var idGroup = idInput.closest('.form-group');
            if (idGroup) {
                idGroup.appendChild(help);
                idGroup.appendChild(genBtn);
            }
        }
    });
})();
</script>
<script>
(function() {
    function addBannerMenuItem() {
        var navLinks = document.querySelectorAll('.navbar-nav > li.dropdown');
        if (!navLinks.length) return;
        var target = null;
        navLinks.forEach(function(item) {
            var label = item.querySelector('a');
            if (label && label.textContent.trim().toLowerCase() === 'content') {
                target = item;
            }
        });
        if (!target) return;
        var menu = target.querySelector('.dropdown-menu');
        if (!menu) return;
        if (menu.querySelector('[data-banner-link="1"]')) return;
        var divider = document.createElement('li');
        divider.className = 'divider';
        var item = document.createElement('li');
        var link = document.createElement('a');
        link.setAttribute('href', '{{ url_for('admin_banner_alert_new') }}');
        link.setAttribute('data-banner-link', '1');
        link.innerHTML = '<i class="fas fa-bolt" style="margin-right: 6px;"></i> Banner alerts';
        item.appendChild(link);
        menu.appendChild(divider);
        menu.appendChild(item);
    }
    document.addEventListener('DOMContentLoaded', addBannerMenuItem);
})();
</script>
{% endblock %}

{% block page_body %}
<main class="dashboard-main">
    {{ super() }}
</main>

<!-- Fixed Right Dashboard (Admin) -->
<aside class="dashboard-sidebar dashboard-right">
    <div class="dashboard-section" id="luke-chapter-section">
        <div class="dashboard-title" style="border-left: none;">Current Teaching Series</div>
        <div class="dashboard-note" id="luke-chapter-content">
            <div class="study-reference">Luke 12:35-59</div>
            <div class="study-title">A Life of Readiness</div>
            <div class="study-date">Rev. Jerry Ornelas ‚Ä¢ 1.25.26</div>
        </div>
    </div>
    <div class="dashboard-section">
        <div class="dashboard-title">Now</div>
        <div class="dashboard-note">
            <div id="liveClock" class="text-white text-lg font-semibold"></div>
            <div id="liveDate" class="text-white/80 text-sm mt-1"></div>
        </div>
    </div>
    <div class="dashboard-section">
        <div class="dashboard-title">Weather ‚Äî New Haven</div>
        <div class="dashboard-note">
            <div id="weatherNow" class="text-white text-lg font-semibold"></div>
            <div id="weatherHiLo" class="text-white/80 text-sm mt-1"></div>
            <div id="weatherDesc" class="text-white/70 text-xs mt-1"></div>
        </div>
    </div>
    <div class="dashboard-section">
        <div class="dashboard-title">Sunday Service</div>
        <div class="dashboard-note">
            10:30am Worship ‚Ä¢ 135 Whitney Ave
        </div>
    </div>
</aside>
{% endblock %}

{% block brand %}
<a class="navbar-brand" href="/admin/dashboard/">
    <i class="fas fa-church"></i> CPC Admin
</a>
{% endblock %}

{% block access_control %}
<div style="display: flex; align-items: center; gap: 0.75rem; margin-right: 1rem; flex-wrap: wrap;">
    <!-- Last-change status bar -->
    <span id="adminLastChange" style="color: rgba(255,255,255,0.55); font-size: 0.8rem; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
        title="Loading last change..."></span>

    {% if session.get('username') %}
    <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem;">
        <i class="fas fa-user-circle"></i> {{ session.get('username') }}
    </span>
    {% endif %}
    <a href="/" target="_blank"
        style="color: var(--text-white); text-decoration: none; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); transition: var(--transition-fast); font-size: 0.85rem;">
        <i class="fas fa-globe"></i> View Site
    </a>
    <a href="{{ url_for('admin_logout') }}"
        style="color: var(--text-white); text-decoration: none; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border-radius: var(--radius-md); transition: var(--transition-fast); font-size: 0.85rem;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>
{% endblock %}

{% block tail %}
{{ super() }}
<script>
(function() {
    var el = document.getElementById('adminLastChange');
    if (!el) return;
    fetch('/api/admin/last-change')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d && d.type && d.title) {
                el.textContent = 'Last: ' + d.type + ' ‚Äî ' + d.title + (d.when ? ' (' + d.when + ')' : '');
                el.title = d.type + ': ' + d.title + (d.when ? ' ‚Äî ' + d.when : '');
            } else {
                el.textContent = 'No recent changes';
            }
        })
        .catch(function() { el.textContent = ''; });
})();
</script>
<script>
(function() {
    function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const date = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
        const t = document.getElementById('liveClock');
        const d = document.getElementById('liveDate');
        if (t) t.textContent = time;
        if (d) d.textContent = date;
    }
    updateClock();
    setInterval(updateClock, 1000 * 30);
})();
</script>
<script>
(function() {
    const elNow = document.getElementById('weatherNow');
    const elHiLo = document.getElementById('weatherHiLo');
    const elDesc = document.getElementById('weatherDesc');
    if (!elNow || !elHiLo || !elDesc) return;
    const url = 'https://api.open-meteo.com/v1/forecast?latitude=41.31&longitude=-72.92&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=America%2FNew_York&temperature_unit=fahrenheit';
    function codeToDesc(c) {
        if (c === 0) return 'Clear sky';
        if (c === 1 || c === 2 || c === 3) return 'Partly cloudy';
        if (c === 45 || c === 48) return 'Fog';
        if (c >= 51 && c <= 57) return 'Drizzle';
        if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'Rain';
        if (c >= 71 && c <= 77) return 'Snow';
        if (c >= 95) return 'Thunderstorms';
        return 'Weather';
    }
    function codeToIcon(c) {
        if (c === 0) return '‚òÄÔ∏è';
        if (c === 1) return 'üå§Ô∏è';
        if (c === 2 || c === 3) return '‚õÖÔ∏è';
        if (c === 45 || c === 48) return 'üå´Ô∏è';
        if (c >= 51 && c <= 57) return 'üå¶Ô∏è';
        if ((c >= 61 && c <= 67) || (c >= 80 && c <= 82)) return 'üåßÔ∏è';
        if (c >= 71 && c <= 77) return '‚ùÑÔ∏è';
        if (c >= 95) return '‚õàÔ∏è';
        return 'üå°Ô∏è';
    }
    async function loadWeather() {
        try {
            const r = await fetch(url, { cache: 'no-store' });
            if (!r.ok) return;
            const d = await r.json();
            const t = Math.round((d.current && d.current.temperature_2m) || 0);
            const c = (d.current && d.current.weather_code) || 0;
            const hi = Math.round((d.daily && d.daily.temperature_2m_max && d.daily.temperature_2m_max[0]) || t);
            const lo = Math.round((d.daily && d.daily.temperature_2m_min && d.daily.temperature_2m_min[0]) || t);
            elNow.textContent = codeToIcon(c) + ' ' + t + '¬∞F';
            elHiLo.textContent = 'H ' + hi + '¬∞ / L ' + lo + '¬∞';
            elDesc.textContent = codeToDesc(c);
        } catch (e) {
            elNow.textContent = 'üå°Ô∏è ‚Äî';
            elHiLo.textContent = '';
            elDesc.textContent = 'Weather unavailable';
        }
    }
    loadWeather();
    setInterval(loadWeather, 1000 * 60 * 15);
})();
</script>
{% endblock %}
