{% extends "admin/dashboard.html" %}

{% block title %}Google Drive Gallery Integration - CPC Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Google Drive Gallery Integration</h1>
        <p>Sync your Google Drive photos directly to the gallery</p>
    </div>

    <!-- Error Message -->
    {% if status.error %}
    <div class="error-section">
        <div class="error-card">
            <h2>⚠️ Google Drive Integration Not Available</h2>
            <p>{{ status.error }}</p>
            <div class="error-actions">
                <button class="btn btn-primary" onclick="installDependencies()">
                    <i class="fas fa-download"></i> Install Dependencies
                </button>
                <button class="btn btn-info" onclick="showInstructions()">
                    <i class="fas fa-info-circle"></i> Show Instructions
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <div class="status-icon">
                <i class="fas fa-key"></i>
            </div>
            <div class="status-content">
                <h3>Credentials</h3>
                <p id="credentials-status">
                    {% if status.has_credentials %}
                    <span class="status-success">✓ Configured</span>
                    {% else %}
                    <span class="status-error">✗ Not configured</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">
                <i class="fas fa-sync"></i>
            </div>
            <div class="status-content">
                <h3>Last Sync</h3>
                <p id="sync-status">
                    {% if status.last_sync %}
                    {{ status.last_sync }}
                    {% else %}
                    Never synced
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">
                <i class="fas fa-images"></i>
            </div>
            <div class="status-content">
                <h3>Images</h3>
                <p>
                    <span id="google-drive-count">{{
                        status.google_drive_images_count or 0 }}</span> from
                    Google Drive
                    <br>
                    <span id="total-count">{{ status.total_images_count or 0
                        }}</span> total
                </p>
            </div>
        </div>
    </div>

    <!-- Setup Section -->
    {% if not status.has_credentials %}
    <div class="setup-section">
        <div class="setup-card">
            <h2>Initial Setup</h2>
            <p>To use Google Drive integration, you need to set up API
                credentials:</p>

            <ol>
                <li>Go to <a href="https://console.cloud.google.com/"
                        target="_blank">Google Cloud Console</a></li>
                <li>Create a new project or select existing one</li>
                <li>Enable Google Drive API</li>
                <li>Create OAuth 2.0 credentials</li>
                <li>Download credentials.json and place in project root</li>
            </ol>

            <button class="btn btn-primary" onclick="setupCredentials()">
                <i class="fas fa-cog"></i> Setup Credentials
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Sync Section -->
    {% if status.has_credentials %}
    <div class="sync-section">
        <div class="sync-card">
            <h2>Sync Gallery</h2>

            <div class="sync-controls">
                <div class="form-group">
                    <label for="folder-name">Google Drive Folder Name:</label>
                    <input type="text" id="folder-name" value="CPC Gallery"
                        class="form-control">
                    <small class="form-text">Enter the name of the Google Drive
                        folder containing your photos</small>
                </div>

                <div class="sync-actions">
                    <button class="btn btn-primary" onclick="testConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button class="btn btn-success" onclick="syncGallery()">
                        <i class="fas fa-sync"></i> Sync Now
                    </button>
                    <button class="btn btn-info" onclick="listFolders()">
                        <i class="fas fa-folder"></i> Browse Folders
                    </button>
                </div>
            </div>

            <div id="sync-progress" class="sync-progress"
                style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p>Syncing images from Google Drive...</p>
            </div>
        </div>
    </div>

    <!-- Folders Section -->
    <div class="folders-section" id="folders-section" style="display: none;">
        <div class="folders-card">
            <h2>Available Folders</h2>
            <div id="folders-list" class="folders-grid">
                <!-- Folders will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Sync Configuration -->
    <div class="config-section">
        <div class="config-card">
            <h2>Automatic Sync Configuration</h2>

            <div class="form-group">
                <label for="sync-interval">Sync Interval:</label>
                <select id="sync-interval" class="form-control">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="manual">Manual Only</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="auto-sync-enabled"> Enable
                    automatic sync
                </label>
            </div>

            <button class="btn btn-primary" onclick="saveSyncConfig()">
                <i class="fas fa-save"></i> Save Configuration
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Help Section -->
    <div class="help-section">
        <div class="help-card">
            <h2>Help & Tips</h2>

            <div class="help-content">
                <h3>Folder Organization</h3>
                <p>Organize your Google Drive photos in folders with descriptive
                    names:</p>
                <ul>
                    <li><strong>Events</strong> - Church events and
                        celebrations</li>
                    <li><strong>Worship</strong> - Sunday services and
                        worship</li>
                    <li><strong>Fellowship</strong> - Community gatherings</li>
                    <li><strong>Youth</strong> - Youth group activities</li>
                    <li><strong>Missions</strong> - Mission trips and
                        outreach</li>
                </ul>

                <h3>File Naming</h3>
                <p>Use descriptive filenames to help with automatic tagging:</p>
                <ul>
                    <li><code>sunday-service-2024-01-15.jpg</code></li>
                    <li><code>youth-group-fellowship.jpg</code></li>
                    <li><code>christmas-celebration-2023.jpg</code></li>
                </ul>

                <h3>Supported Formats</h3>
                <p>All common image formats are supported: JPG, PNG, GIF, WebP,
                    etc.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.status-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.status-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.status-content h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.status-content p {
    margin: 0;
    color: #666;
}

.status-success {
    color: #28a745;
    font-weight: 500;
}

.status-error {
    color: #dc3545;
    font-weight: 500;
}

.error-section {
    margin-bottom: 2rem;
}

.error-card {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
}

.error-card h2 {
    color: #856404;
    margin-bottom: 1rem;
}

.error-card p {
    color: #856404;
    margin-bottom: 1.5rem;
}

.error-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.setup-section, .sync-section, .folders-section, .config-section, .help-section {
    margin-bottom: 2rem;
}

.setup-card, .sync-card, .folders-card, .config-card, .help-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.sync-controls {
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
}

.sync-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a6fd8;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
}

.sync-progress {
    margin-top: 1rem;
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    width: 0%;
    transition: width 0.3s ease;
    animation: progress-animation 2s infinite;
}

@keyframes progress-animation {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}

.folders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.folder-item {
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.folder-item:hover {
    border-color: #667eea;
    background: #f0f2ff;
}

.folder-item.selected {
    border-color: #667eea;
    background: #e3f2fd;
}

.folder-name {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #333;
}

.folder-date {
    font-size: 0.9rem;
    color: #666;
}

.help-content h3 {
    color: #333;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

.help-content ul {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.help-content li {
    margin-bottom: 0.5rem;
    color: #666;
}

.help-content code {
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #e83e8c;
}

@media (max-width: 768px) {
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .sync-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
// Global variables
let selectedFolderId = null;

// Install dependencies
function installDependencies() {
    const command = 'pip install google-api-python-client google-auth-oauthlib google-auth';
    
    // Copy command to clipboard
    if (navigator.clipboard) {
        navigator.clipboard.writeText(command).then(() => {
            alert('Command copied to clipboard! Run it in your terminal:\n\n' + command);
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = command;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Command copied to clipboard! Run it in your terminal:\n\n' + command);
    }
}

// Show instructions
function showInstructions() {
    const instructions = `
Google Drive Integration Setup Instructions:

1. Install Dependencies:
   pip install google-api-python-client google-auth-oauthlib google-auth

2. Set up Google Cloud Console:
   - Go to https://console.cloud.google.com/
   - Create a new project or select existing one
   - Enable Google Drive API
   - Create OAuth 2.0 credentials (Desktop application)
   - Download credentials.json to project root

3. Restart the application

4. Access the Google Drive integration at /admin/google-drive
    `;
    
    alert(instructions);
}

// Setup credentials
function setupCredentials() {
    fetch('/admin/google-drive/setup', {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            alert('Please follow the instructions in the console to set up Google Drive credentials.');
        } else {
            alert('Setup failed. Please check the console for details.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Setup failed: ' + error.message);
    });
}

// Test connection
function testConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    button.disabled = true;
    
    fetch('/admin/google-drive/test-connection')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Connection successful!');
        } else {
            alert('❌ Connection failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Connection test failed: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Sync gallery
function syncGallery() {
    const folderName = document.getElementById('folder-name').value;
    const progressDiv = document.getElementById('sync-progress');
    const button = event.target;
    const originalText = button.innerHTML;
    
    if (!folderName.trim()) {
        alert('Please enter a folder name');
        return;
    }
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    button.disabled = true;
    progressDiv.style.display = 'block';
    
    const formData = new FormData();
    formData.append('folder_name', folderName);
    
    fetch('/admin/google-drive/sync', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            alert('✅ Gallery synced successfully!');
            location.reload(); // Refresh to show updated status
        } else {
            alert('❌ Sync failed. Please check the console for details.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Sync failed: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        progressDiv.style.display = 'none';
    });
}

// List folders
function listFolders() {
    const foldersSection = document.getElementById('folders-section');
    const foldersList = document.getElementById('folders-list');
    
    foldersSection.style.display = 'block';
    foldersList.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading folders...</div>';
    
    fetch('/admin/google-drive/folders')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            foldersList.innerHTML = '<div class="text-center text-danger">Error: ' + data.error + '</div>';
            return;
        }
        
        if (data.folders.length === 0) {
            foldersList.innerHTML = '<div class="text-center text-muted">No folders found</div>';
            return;
        }
        
        foldersList.innerHTML = data.folders.map(folder => `
            <div class="folder-item" onclick="selectFolder('${folder.id}', '${folder.name}')">
                <div class="folder-name">${folder.name}</div>
                <div class="folder-date">Created: ${new Date(folder.createdTime).toLocaleDateString()}</div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error:', error);
        foldersList.innerHTML = '<div class="text-center text-danger">Error loading folders: ' + error.message + '</div>';
    });
}

// Select folder
function selectFolder(folderId, folderName) {
    selectedFolderId = folderId;
    
    // Update UI
    document.querySelectorAll('.folder-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.target.closest('.folder-item').classList.add('selected');
    
    // Update folder name input
    document.getElementById('folder-name').value = folderName;
}

// Save sync configuration
function saveSyncConfig() {
    const syncInterval = document.getElementById('sync-interval').value;
    const autoSyncEnabled = document.getElementById('auto-sync-enabled').checked;
    
    const config = {
        sync_interval: syncInterval,
        enabled: autoSyncEnabled
    };
    
    fetch('/admin/google-drive/sync-schedule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Configuration saved successfully!');
        } else {
            alert('❌ Failed to save configuration: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error saving configuration: ' + error.message);
    });
}

// Load sync configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/admin/google-drive/sync-config')
    .then(response => response.json())
    .then(config => {
        if (config.sync_interval) {
            document.getElementById('sync-interval').value = config.sync_interval;
        }
        if (config.enabled !== undefined) {
            document.getElementById('auto-sync-enabled').checked = config.enabled;
        }
    })
    .catch(error => {
        console.error('Error loading sync config:', error);
    });
});
</script>
{% endblock %}
