{% extends "base.html" %}

{% block title %}Sunday Sermons - CPC New Haven{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="page-hero">
    <div class="container">
        <h1>Sunday Sermons</h1>
        <p>Weekly messages from our Sunday worship services</p>
    </div>
</section>

<!-- Sermons Section -->
<section class="sermons-section">
    <div class="container">
        <!-- Search and Filter Controls -->
        <div class="sermon-controls">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search sermons..." x-model="searchQuery" @input="filterSermons()">
            </div>
            <div class="view-controls">
                <button @click="viewMode = 'card'" :class="{'active': viewMode === 'card'}">Card View</button>
                <button @click="viewMode = 'table'" :class="{'active': viewMode === 'table'}">Table View</button>
            </div>
            <div class="sort-controls">
                <select @change="sortKey = $event.target.value; sortSermons()">
                    <option value="date">Sort by Date</option>
                    <option value="title">Sort by Title</option>
                    <option value="author">Sort by Speaker</option>
                </select>
                <button @click="sortAsc = !sortAsc; sortSermons()" :class="{'asc': sortAsc, 'desc': !sortAsc}">
                    <span x-text="sortAsc ? '↑' : '↓'"></span>
                </button>
            </div>
        </div>

        <!-- Alpine.js Component -->
        <div x-data="sermonData()" x-init="init()">
            <!-- Loading State -->
            <div x-show="!loadingComplete" class="loading">
                <p>Loading sermons...</p>
            </div>

            <!-- Card View -->
            <div x-show="loadingComplete && viewMode === 'card'" class="sermons-grid">
                <template x-for="sermon in filteredSermons" :key="sermon.id">
                    <div class="sermon-card">
                        <div class="sermon-thumbnail" x-show="sermon['podcast-thumbnail_url']">
                            <img :src="sermon['podcast-thumbnail_url']" :alt="sermon.title" loading="lazy">
                        </div>
                        <div class="sermon-content">
                            <h3 class="sermon-title" x-text="sermon.title"></h3>
                            <p class="sermon-meta">
                                <span class="sermon-author" x-text="sermon.author"></span> •
                                <span class="sermon-date" x-text="sermon.displayDate"></span>
                            </p>
                            <p class="sermon-scripture" x-text="sermon.scripture" x-show="sermon.scripture"></p>
                            <div class="sermon-links">
                                <a :href="sermon.spotify_url" x-show="sermon.spotify_url" target="_blank" class="btn btn-spotify">Spotify</a>
                                <a :href="sermon.youtube_url" x-show="sermon.youtube_url" target="_blank" class="btn btn-youtube">YouTube</a>
                                <a :href="sermon.apple_podcasts_url" x-show="sermon.apple_podcasts_url" target="_blank" class="btn btn-apple">Apple</a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Table View -->
            <div x-show="loadingComplete && viewMode === 'table'" class="table-responsive">
                <table class="sermons-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Title</th>
                            <th>Speaker</th>
                            <th>Scripture</th>
                            <th>Links</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="sermon in filteredSermons" :key="sermon.id">
                            <tr>
                                <td x-text="sermon.displayDate"></td>
                                <td x-text="sermon.title"></td>
                                <td x-text="sermon.author"></td>
                                <td x-text="sermon.scripture"></td>
                                <td class="sermon-links">
                                    <a :href="sermon.spotify_url" x-show="sermon.spotify_url" target="_blank">Spotify</a>
                                    <a :href="sermon.youtube_url" x-show="sermon.youtube_url" target="_blank">YouTube</a>
                                    <a :href="sermon.apple_podcasts_url" x-show="sermon.apple_podcasts_url" target="_blank">Apple</a>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- No Results -->
            <div x-show="loadingComplete && filteredSermons.length === 0" class="no-results">
                <p>No sermons found matching your search criteria.</p>
            </div>

            <!-- Results Count -->
            <div x-show="loadingComplete" class="results-count">
                <p>Showing <span x-text="filteredSermons.length"></span> of <span x-text="sermons.length"></span> sermons</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- Modified Sunday Sermons JavaScript -->
<script>
// Updated sunday-sermons.js to use API endpoint
window.sermonData = function() {
    return {
        sortKey: 'date',
        sortAsc: false,
        searchQuery: '',
        viewMode: 'card', // Default to card view
        sermons: [],
        filteredSermons: [],
        loadingComplete: false,
        
        init() {
            this.loadSermons();
        },
        
        loadSermons() {
            console.log('loadSermons called');
            // Changed to use Flask API endpoint
            fetch('/api/sermons')
                .then(response => {
                    console.log('Response received:', response);
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data loaded:', data);
                    console.log('Episodes count:', data.episodes ? data.episodes.length : 'no episodes');
                    // Format dates for display - always show as Sunday sermons
                    this.sermons = (data.episodes || []).map(sermon => ({
                        ...sermon,
                        displayDate: sermon.date ? this.formatSundayDate(sermon.date) : sermon.date
                    }));
                    this.filteredSermons = [...this.sermons];
                    this.sortSermons();
                    this.loadingComplete = true;
                    console.log('Sermons loaded:', this.sermons.length);
                    console.log('Filtered sermons:', this.filteredSermons.length);
                })
                .catch(error => {
                    console.error('Error loading sermons:', error);
                    console.error('Error details:', error.message);
                    this.sermons = [];
                    this.filteredSermons = [];
                    this.loadingComplete = true;
                });
        },

        formatSundayDate(dateString) {
            // Parse the date string and ensure it's treated as local time, not UTC
            const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
            const date = new Date(year, month - 1, day); // month is 0-indexed in JavaScript
            
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return `Sunday, ${date.toLocaleDateString('en-US', options)}`;
        },

        filterSermons() {
            console.log('filterSermons called');
            if (!this.searchQuery.trim()) {
                this.filteredSermons = [...this.sermons];
            } else {
                const query = this.searchQuery.toLowerCase();
                this.filteredSermons = this.sermons.filter(sermon => 
                    sermon.title?.toLowerCase().includes(query) ||
                    sermon.author?.toLowerCase().includes(query) ||
                    sermon.scripture?.toLowerCase().includes(query) ||
                    sermon.date?.toLowerCase().includes(query)
                );
            }
            this.sortSermons();
        },

        sortSermons() {
            console.log('sortSermons called');
            this.filteredSermons.sort((a, b) => {
                let aValue = a[this.sortKey] || '';
                let bValue = b[this.sortKey] || '';
                
                // Handle date sorting
                if (this.sortKey === 'date') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else {
                    // String sorting
                    aValue = aValue.toString().toLowerCase();
                    bValue = bValue.toString().toLowerCase();
                }
                
                if (aValue < bValue) {
                    return this.sortAsc ? -1 : 1;
                }
                if (aValue > bValue) {
                    return this.sortAsc ? 1 : -1;
                }
                return 0;
            });
        }
    };
};
</script>
{% endblock %}
