{% extends "base.html" %}

{% block title %}Sunday Sermons - CPC New Haven{% endblock %}

{% block head %}
<style>
/* Alpine.js x-cloak - hide elements until Alpine processes them */
[x-cloak] {
    display: none !important;
}

/* Sermons Page - Maximized Layout for 25 Years of Content */
.sermons-page {
    min-height: calc(100vh - 200px);
    padding: 2rem 0;
}

.page-hero {
    padding: 2rem 0;
    text-align: center;
    background: transparent;
    height: auto;
}

.page-hero h1 {
    font-size: 2.5rem;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.5rem;
}

.page-hero p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
}

.sermons-section {
    max-width: 100%;
    padding: 0 1rem;
    margin: 0 auto;
}

.sermon-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    align-items: center;
}

.search-container {
    flex: 1;
    min-width: 250px;
}

.search-container input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
}

.search-container input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.view-controls {
    display: flex;
    gap: 0.5rem;
}

.view-controls button {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition: all 0.2s;
}

.view-controls button.active {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
}

.view-controls button:hover {
    background: rgba(255, 255, 255, 0.15);
}

.sort-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.sort-controls select {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
}

.sort-controls button {
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
}

/* Sermons Grid - Optimized for Maximum Space */
.sermons-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    padding: 1rem 0;
    max-width: 100%;
    min-height: 400px;
    width: 100%;
}

/* Override Alpine.js display: none when element should be visible */
.sermons-grid:not([style*="display: none"]) {
    display: grid !important;
}

.sermon-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    min-height: 200px;
}

.sermon-card:hover {
    transform: translateY(-4px);
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.sermon-thumbnail {
    width: 100%;
    height: 140px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
    background: rgba(255, 255, 255, 0.05);
}

.sermon-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.sermon-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.sermon-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.75rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.sermon-meta {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.5rem;
}

.sermon-scripture {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    font-style: italic;
    margin-bottom: 1rem;
}

.sermon-links {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: auto;
}

.sermon-links a {
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-spotify {
    background: #1db954;
    color: white;
}

.btn-spotify:hover {
    background: #1ed760;
}

.btn-youtube {
    background: #ff0000;
    color: white;
}

.btn-youtube:hover {
    background: #ff3333;
}

.btn-apple {
    background: #000;
    color: white;
}

.btn-apple:hover {
    background: #333;
}

/* Table View - Styled to Match Page Vibe */
.table-responsive {
    width: 100%;
    overflow-x: auto;
    margin-top: 1rem;
    border-radius: 12px;
    background: rgba(0, 50, 120, 0.15);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px rgba(0, 50, 120, 0.2);
}

.sermons-table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
}

.sermons-table thead {
    background: rgba(0, 50, 120, 0.25);
    backdrop-filter: blur(10px);
}

.sermons-table th {
    padding: 1.25rem 1rem;
    text-align: left;
    color: rgba(255, 255, 255, 0.95);
    font-weight: 600;
    font-size: 0.95rem;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.85rem;
}

.sermons-table td {
    padding: 1rem;
    color: rgba(255, 255, 255, 0.85);
    font-size: 0.9rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sermons-table tbody tr {
    transition: all 0.2s ease;
}

.sermons-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(2px);
}

.sermons-table .sermon-links {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.sermons-table .sermon-links a {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
}

.sermons-table .sermon-links a[href*="spotify"] {
    background: #1db954;
    color: white;
}

.sermons-table .sermon-links a[href*="spotify"]:hover {
    background: #1ed760;
    transform: translateY(-1px);
}

.sermons-table .sermon-links a[href*="youtube"] {
    background: #ff0000;
    color: white;
}

.sermons-table .sermon-links a[href*="youtube"]:hover {
    background: #ff3333;
    transform: translateY(-1px);
}

.sermons-table .sermon-links a[href*="apple"] {
    background: #000;
    color: white;
}

.sermons-table .sermon-links a[href*="apple"]:hover {
    background: #333;
    transform: translateY(-1px);
}

/* Loading and Empty States */
.loading, .no-results {
    text-align: center;
    padding: 3rem;
    color: rgba(255, 255, 255, 0.7);
}

.results-count {
    text-align: center;
    padding: 1rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-top: 1rem;
}

/* Ensure grid displays correctly when visible */
/* Alpine.js x-show adds style="display: none" when hidden */
.sermons-grid {
    display: grid !important;
}

/* When Alpine.js adds inline style="display: none", respect it */
.sermons-grid[style*="display: none"] {
    display: none !important;
}

/* Ensure table displays when visible */
.table-responsive {
    display: block !important;
}

.table-responsive[style*="display: none"] {
    display: none !important;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sermons-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .sermon-controls {
        flex-direction: column;
    }
    
    .search-container {
        width: 100%;
    }
    
    .sermons-table {
        font-size: 0.85rem;
    }
    
    .sermons-table th,
    .sermons-table td {
        padding: 0.5rem;
    }
}

@media (min-width: 1200px) {
    .sermons-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

@media (min-width: 1600px) {
    .sermons-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="page-hero">
    <div class="container">
        <h1>Sunday Sermons</h1>
        <p>Weekly messages from our Sunday worship services • 25 Years of Archive</p>
    </div>
</section>

<!-- Sermons Section -->
<section class="sermons-section sermons-page">
    <div class="container" style="max-width: 100%; padding: 0 2rem;">
        <!-- Alpine.js Component -->
        <div x-data="sermonData()" x-init="init()">
            <!-- Search and Filter Controls -->
            <div class="sermon-controls">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search sermons..." x-model="searchQuery" @input="filterSermons()">
                </div>
                <div class="view-controls">
                    <button @click="viewMode = 'card'" :class="{'active': viewMode === 'card'}">Card View</button>
                    <button @click="viewMode = 'table'" :class="{'active': viewMode === 'table'}">Table View</button>
                </div>
                <div class="sort-controls">
                    <select @change="sortKey = $event.target.value; sortSermons()">
                        <option value="date">Sort by Date</option>
                        <option value="title">Sort by Title</option>
                        <option value="author">Sort by Speaker</option>
                    </select>
                    <button @click="sortAsc = !sortAsc; sortSermons()" :class="{'asc': sortAsc, 'desc': !sortAsc}">
                        <span x-text="sortAsc ? '↑' : '↓'"></span>
                    </button>
                </div>
            </div>
            <!-- Loading State -->
            <div x-show="!loadingComplete" class="loading" style="display: none;">
                <p>Loading sermons...</p>
            </div>
            
            <!-- Card View -->
            <div x-show="loadingComplete && viewMode === 'card' && filteredSermons.length > 0" 
                 class="sermons-grid"
                 x-cloak>
                <template x-for="(sermon, index) in filteredSermons" :key="sermon?.id || index">
                    <div class="sermon-card">
                        <div class="sermon-thumbnail" x-show="sermon['podcast-thumbnail_url']">
                            <img :src="sermon['podcast-thumbnail_url']" :alt="sermon.title" loading="lazy">
                        </div>
                        <div class="sermon-content">
                            <h3 class="sermon-title" x-text="sermon.title"></h3>
                            <p class="sermon-meta">
                                <span class="sermon-author" x-text="sermon.author"></span> •
                                <span class="sermon-date" x-text="sermon.displayDate"></span>
                            </p>
                            <p class="sermon-scripture" x-text="sermon.scripture" x-show="sermon.scripture"></p>
                            <div class="sermon-links">
                                <a :href="sermon.spotify_url" x-show="sermon.spotify_url" target="_blank" class="btn btn-spotify">Spotify</a>
                                <a :href="sermon.youtube_url" x-show="sermon.youtube_url" target="_blank" class="btn btn-youtube">YouTube</a>
                                <a :href="sermon.apple_podcasts_url" x-show="sermon.apple_podcasts_url" target="_blank" class="btn btn-apple">Apple</a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Table View -->
            <div x-show="loadingComplete && viewMode === 'table' && filteredSermons.length > 0" 
                 class="table-responsive" 
                 style="max-height: calc(100vh - 400px); overflow-y: auto;">
                <table class="sermons-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Title</th>
                            <th>Speaker</th>
                            <th>Scripture</th>
                            <th>Links</th>
                        </tr>
                    </thead>
                    <tbody id="sermons-tbody">
                        <template x-for="(sermon, index) in filteredSermons" :key="sermon?.id || index">
                            <tr>
                                <td x-text="sermon.displayDate || sermon.date || 'N/A'"></td>
                                <td x-text="sermon.title || 'Untitled'"></td>
                                <td x-text="sermon.author || 'Unknown'"></td>
                                <td x-text="sermon.scripture || '-'"></td>
                                <td class="sermon-links">
                                    <a x-show="sermon.spotify_url" :href="sermon.spotify_url" target="_blank" rel="noopener">Spotify</a>
                                    <a x-show="sermon.youtube_url" :href="sermon.youtube_url" target="_blank" rel="noopener">YouTube</a>
                                    <a x-show="sermon.apple_podcasts_url" :href="sermon.apple_podcasts_url" target="_blank" rel="noopener">Apple</a>
                                    <span x-show="!sermon.spotify_url && !sermon.youtube_url && !sermon.apple_podcasts_url" style="color: rgba(255,255,255,0.5);">-</span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- No Results -->
            <div x-show="loadingComplete && filteredSermons.length === 0" class="no-results">
                <p>No sermons found matching your search criteria.</p>
            </div>

            <!-- Results Count -->
            <div x-show="loadingComplete" class="results-count">
                <p>Showing <span x-text="filteredSermons.length"></span> of <span x-text="sermons.length"></span> sermons</p>
            </div>
            
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- Modified Sunday Sermons JavaScript -->
<script>
// Updated sunday-sermons.js to use API endpoint
window.sermonData = function() {
    return {
        sortKey: 'date',
        sortAsc: false,
        searchQuery: '',
        viewMode: 'table', // Default to table view
        sermons: [],
        filteredSermons: [],
        loadingComplete: false,
        
        init() {
            this.loadSermons();
        },
        
        loadSermons() {
            console.log('loadSermons called');
            this.loadingComplete = false;
            // Changed to use Flask API endpoint
            fetch('/api/sermons')
                .then(response => {
                    console.log('Response received:', response);
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data loaded:', data);
                    console.log('Episodes count:', data.episodes ? data.episodes.length : 'no episodes');
                    
                    if (!data.episodes || data.episodes.length === 0) {
                        console.error('No episodes in response!');
                        this.loadingComplete = true;
                        return;
                    }
                    
                    // Format dates for display - always show as Sunday sermons
                    this.sermons = (data.episodes || []).map(sermon => ({
                        ...sermon,
                        displayDate: sermon.date ? this.formatSundayDate(sermon.date) : sermon.date
                    }));
                    
                    console.log('Mapped sermons:', this.sermons.length);
                    console.log('First sermon:', this.sermons[0]);
                    console.log('First sermon keys:', Object.keys(this.sermons[0] || {}));
                    
                    // Ensure filteredSermons is a proper array and all items have required fields
                    this.filteredSermons = Array.isArray(this.sermons) 
                        ? this.sermons.filter(s => s != null).map(s => ({
                            ...s,
                            id: s.id || `sermon-${s.date || 'unknown'}-${s.title?.substring(0, 10) || 'untitled'}`
                        }))
                        : [];
                    this.sortSermons();
                    
                    console.log('After sort - Filtered sermons:', this.filteredSermons.length);
                    console.log('First filtered sermon:', this.filteredSermons[0]);
                    console.log('First sermon has ID:', !!this.filteredSermons[0]?.id);
                    
                    // Use $nextTick to ensure Alpine.js processes the data
                    this.loadingComplete = true;
                    
                    console.log('Sermons loaded:', this.sermons.length);
                    console.log('Filtered sermons:', this.filteredSermons.length);
                    console.log('View mode:', this.viewMode);
                    console.log('Loading complete:', this.loadingComplete);
                    
                    // Force display update and check if rows rendered
                    setTimeout(() => {
                        console.log('=== DISPLAY CHECK ===');
                        console.log('View mode:', this.viewMode);
                        console.log('Loading complete:', this.loadingComplete);
                        console.log('Sermons count:', this.sermons.length);
                        console.log('Filtered count:', this.filteredSermons.length);
                        
                        const grid = document.querySelector('.sermons-grid');
                        const table = document.querySelector('.table-responsive');
                        const tbody = document.querySelector('.sermons-table tbody');
                        
                        console.log('Grid element found:', !!grid);
                        console.log('Table element found:', !!table);
                        console.log('Tbody element found:', !!tbody);
                        
                        const tbody = document.getElementById('sermons-tbody');
                        if (tbody) {
                            const rows = tbody.querySelectorAll('tr');
                            console.log('Number of rows in tbody:', rows.length);
                            console.log('Expected rows:', this.filteredSermons.length);
                            console.log('Tbody innerHTML length:', tbody.innerHTML.length);
                            
                            // If no rows rendered but we have data, manually render
                            if (rows.length === 0 && this.filteredSermons.length > 0 && this.viewMode === 'table') {
                                console.log('⚠️ No rows rendered by Alpine.js! Manually rendering...');
                                this.renderTableManually(tbody);
                            } else if (rows.length > 0) {
                                console.log('✓ Rows rendered successfully by Alpine.js');
                            }
                        }
                        
                        if (grid) {
                            const computed = window.getComputedStyle(grid);
                            console.log('Grid computed display:', computed.display);
                            const shouldShow = this.loadingComplete && this.viewMode === 'card' && this.filteredSermons.length > 0;
                            if (shouldShow && computed.display === 'none') {
                                grid.style.setProperty('display', 'grid', 'important');
                                console.log('✓ Grid forced to display: grid');
                            }
                        }
                        
                        if (table) {
                            const computed = window.getComputedStyle(table);
                            console.log('Table computed display:', computed.display);
                            const shouldShow = this.loadingComplete && this.viewMode === 'table' && this.filteredSermons.length > 0;
                            if (shouldShow && computed.display === 'none') {
                                table.style.setProperty('display', 'block', 'important');
                                console.log('✓ Table forced to display: block');
                            }
                        }
                        console.log('=== END DISPLAY CHECK ===');
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error loading sermons:', error);
                    console.error('Error details:', error.message);
                    this.sermons = [];
                    this.filteredSermons = [];
                    this.loadingComplete = true;
                });
        },

        formatSundayDate(dateString) {
            // Parse the date string and ensure it's treated as local time, not UTC
            const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
            const date = new Date(year, month - 1, day); // month is 0-indexed in JavaScript
            
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return `Sunday, ${date.toLocaleDateString('en-US', options)}`;
        },

        filterSermons() {
            console.log('filterSermons called');
            if (!this.searchQuery.trim()) {
                this.filteredSermons = [...this.sermons];
            } else {
                const query = this.searchQuery.toLowerCase();
                this.filteredSermons = this.sermons.filter(sermon => 
                    sermon.title?.toLowerCase().includes(query) ||
                    sermon.author?.toLowerCase().includes(query) ||
                    sermon.scripture?.toLowerCase().includes(query) ||
                    sermon.date?.toLowerCase().includes(query)
                );
            }
            this.sortSermons();
        },

        sortSermons() {
            console.log('sortSermons called');
            this.filteredSermons.sort((a, b) => {
                let aValue = a[this.sortKey] || '';
                let bValue = b[this.sortKey] || '';
                
                // Handle date sorting
                if (this.sortKey === 'date') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else {
                    // String sorting
                    aValue = aValue.toString().toLowerCase();
                    bValue = bValue.toString().toLowerCase();
                }
                
                if (aValue < bValue) {
                    return this.sortAsc ? -1 : 1;
                }
                if (aValue > bValue) {
                    return this.sortAsc ? 1 : -1;
                }
                return 0;
            });
        },
        
        renderTableManually(tbody) {
            // Clear existing content
            tbody.innerHTML = '';
            
            // Render each sermon as a table row
            this.filteredSermons.forEach(sermon => {
                const tr = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = sermon.displayDate || sermon.date || 'N/A';
                tr.appendChild(dateCell);
                
                const titleCell = document.createElement('td');
                titleCell.textContent = sermon.title || 'Untitled';
                tr.appendChild(titleCell);
                
                const authorCell = document.createElement('td');
                authorCell.textContent = sermon.author || 'Unknown';
                tr.appendChild(authorCell);
                
                const scriptureCell = document.createElement('td');
                scriptureCell.textContent = sermon.scripture || '-';
                tr.appendChild(scriptureCell);
                
                const linksCell = document.createElement('td');
                linksCell.className = 'sermon-links';
                
                if (sermon.spotify_url) {
                    const spotifyLink = document.createElement('a');
                    spotifyLink.href = sermon.spotify_url;
                    spotifyLink.target = '_blank';
                    spotifyLink.rel = 'noopener';
                    spotifyLink.textContent = 'Spotify';
                    linksCell.appendChild(spotifyLink);
                }
                
                if (sermon.youtube_url) {
                    const youtubeLink = document.createElement('a');
                    youtubeLink.href = sermon.youtube_url;
                    youtubeLink.target = '_blank';
                    youtubeLink.rel = 'noopener';
                    youtubeLink.textContent = 'YouTube';
                    linksCell.appendChild(youtubeLink);
                }
                
                if (sermon.apple_podcasts_url) {
                    const appleLink = document.createElement('a');
                    appleLink.href = sermon.apple_podcasts_url;
                    appleLink.target = '_blank';
                    appleLink.rel = 'noopener';
                    appleLink.textContent = 'Apple';
                    linksCell.appendChild(appleLink);
                }
                
                if (!sermon.spotify_url && !sermon.youtube_url && !sermon.apple_podcasts_url) {
                    const span = document.createElement('span');
                    span.style.color = 'rgba(255,255,255,0.5)';
                    span.textContent = '-';
                    linksCell.appendChild(span);
                }
                
                tr.appendChild(linksCell);
                tbody.appendChild(tr);
            });
            
            console.log('✓ Manually rendered', this.filteredSermons.length, 'rows');
        }
    };
};
</script>
{% endblock %}
